


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AdminController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.aiplatform.controller</a>
</div>

<h1>Coverage Summary for Class: AdminController (com.aiplatform.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AdminController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (14/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    73.7%
  </span>
  <span class="absValue">
    (28/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    93.3%
  </span>
  <span class="absValue">
    (152/163)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.aiplatform.controller;
&nbsp;
&nbsp;import com.aiplatform.dto.UserDTO;
&nbsp;import com.aiplatform.entity.AdminMessage;
&nbsp;import com.aiplatform.entity.User;
&nbsp;import com.aiplatform.repository.AdminMessageRepository;
&nbsp;import com.aiplatform.repository.UserRepository;
&nbsp;import com.aiplatform.repository.SupportChatRepository;
&nbsp;import com.aiplatform.entity.SupportChat;
&nbsp;import com.aiplatform.service.UserService;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import io.swagger.v3.oas.annotations.Operation;
&nbsp;import io.swagger.v3.oas.annotations.tags.Tag;
&nbsp;import jakarta.validation.Valid;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.security.core.Authentication;
&nbsp;import org.springframework.security.core.context.SecurityContextHolder;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;@RestController
&nbsp;@RequestMapping(&quot;/admin&quot;)
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Tag(name = &quot;管理员管理&quot;, description = &quot;管理员相关接口&quot;)
&nbsp;public class AdminController {
&nbsp;
&nbsp;    private final UserService userService;
&nbsp;    private final UserRepository userRepository;
&nbsp;    private final AdminMessageRepository adminMessageRepository;
&nbsp;    private final SupportChatRepository supportChatRepository;
&nbsp;    private final ObjectMapper objectMapper;
&nbsp;
&nbsp;    @Operation(summary = &quot;获取用户列表&quot;, description = &quot;分页获取用户列表&quot;)
&nbsp;    @GetMapping(&quot;/users&quot;)
&nbsp;    @PreAuthorize(&quot;hasRole(&#39;admin&#39;)&quot;)
&nbsp;    public ResponseEntity&lt;Page&lt;UserDTO.UserResponse&gt;&gt; getUsers(
&nbsp;            @RequestParam(defaultValue = &quot;&quot;) String keyword,
&nbsp;            @RequestParam(defaultValue = &quot;0&quot;) int page,
&nbsp;            @RequestParam(defaultValue = &quot;20&quot;) int size,
&nbsp;            @RequestParam(defaultValue = &quot;createdAt&quot;) String sortBy,
&nbsp;            @RequestParam(defaultValue = &quot;desc&quot;) String sortDirection) {
&nbsp;        
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;=== AdminController.getUsers 开始 ===&quot;);</b>
<b class="fc">&nbsp;            log.info(&quot;管理员获取用户列表请求: keyword={}, page={}, size={}&quot;, keyword, page, size);</b>
&nbsp;            
&nbsp;            // 检查当前用户权限
<b class="fc">&nbsp;            Authentication auth = SecurityContextHolder.getContext().getAuthentication();</b>
<b class="fc">&nbsp;            log.info(&quot;当前请求用户: name={}, authenticated={}, authorities={}&quot;, </b>
<b class="fc">&nbsp;                    auth.getName(), auth.isAuthenticated(), auth.getAuthorities());</b>
&nbsp;            
<b class="fc">&nbsp;            UserDTO.UserSearchRequest request = new UserDTO.UserSearchRequest();</b>
<b class="fc">&nbsp;            request.setKeyword(keyword);</b>
<b class="fc">&nbsp;            request.setPage(page);</b>
<b class="fc">&nbsp;            request.setSize(size);</b>
<b class="fc">&nbsp;            request.setSortBy(sortBy);</b>
<b class="fc">&nbsp;            request.setSortDirection(sortDirection);</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;调用 UserService.searchUsers...&quot;);</b>
<b class="fc">&nbsp;            Page&lt;UserDTO.UserResponse&gt; users = userService.searchUsers(request);</b>
<b class="fc">&nbsp;            log.info(&quot;用户列表查询成功: 总数={}, 当前页数量={}&quot;, users.getTotalElements(), users.getNumberOfElements());</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;=== AdminController.getUsers 结束 ===&quot;);</b>
<b class="fc">&nbsp;            return ResponseEntity.ok(users);</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;获取用户列表失败: {}&quot;, e.getMessage(), e);</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(summary = &quot;更新用户状态&quot;, description = &quot;更新指定用户的状态&quot;)
&nbsp;    @PatchMapping(&quot;/users/{userId}/status&quot;)
&nbsp;    public ResponseEntity&lt;String&gt; updateUserStatus(
&nbsp;            @PathVariable Long userId,
&nbsp;            @Valid @RequestBody UserDTO.UserStatusUpdateRequest request) {
&nbsp;        
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;=== AdminController.updateUserStatus 开始 ===&quot;);</b>
<b class="fc">&nbsp;            log.info(&quot;更新用户状态: userId={}, newStatus={}&quot;, userId, request.getStatus());</b>
&nbsp;            
<b class="fc">&nbsp;            userService.updateUserStatus(userId, request);</b>
<b class="fc">&nbsp;            log.info(&quot;用户状态更新成功&quot;);</b>
&nbsp;            
<b class="fc">&nbsp;            return ResponseEntity.ok(&quot;用户状态更新成功&quot;);</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;更新用户状态失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(&quot;更新失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(summary = &quot;获取用户统计信息&quot;, description = &quot;获取系统用户的统计数据&quot;)
&nbsp;    @GetMapping(&quot;/statistics&quot;)
&nbsp;    public ResponseEntity&lt;UserDTO.UserStatistics&gt; getUserStatistics() {
&nbsp;        try {
<b class="fc">&nbsp;            UserDTO.UserStatistics statistics = userService.getUserStatistics();</b>
<b class="fc">&nbsp;            return ResponseEntity.ok(statistics);</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;获取用户统计信息失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;获取统计信息失败&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(summary = &quot;发送系统消息&quot;, description = &quot;向指定用户发送系统消息&quot;)
&nbsp;    @PostMapping(&quot;/users/{userId}/message&quot;)
&nbsp;    public ResponseEntity&lt;String&gt; sendMessageToUser(
&nbsp;            @PathVariable Long userId,
&nbsp;            @RequestBody Map&lt;String, Object&gt; request) {
&nbsp;        
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;管理员向用户 {} 发送消息&quot;, userId);</b>
&nbsp;            
<b class="fc">&nbsp;            String content = (String) request.get(&quot;content&quot;);</b>
<b class="fc">&nbsp;            String title = (String) request.get(&quot;title&quot;);</b>
&nbsp;            
<b class="pc">&nbsp;            if (content == null || content.trim().isEmpty()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.badRequest().body(&quot;消息内容不能为空&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 验证目标用户存在
<b class="fc">&nbsp;            Optional&lt;User&gt; targetUser = userRepository.findById(userId);</b>
<b class="fc">&nbsp;            if (!targetUser.isPresent()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.notFound().build();</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 获取当前管理员用户
<b class="fc">&nbsp;            Authentication auth = SecurityContextHolder.getContext().getAuthentication();</b>
<b class="fc">&nbsp;            String adminEmail = auth.getName();</b>
<b class="fc">&nbsp;            Optional&lt;User&gt; adminUser = userRepository.findByEmail(adminEmail);</b>
&nbsp;            
<b class="fc">&nbsp;            if (!adminUser.isPresent()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.status(403).body(&quot;管理员用户不存在&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 创建管理员消息
<b class="fc">&nbsp;            AdminMessage adminMessage = new AdminMessage();</b>
<b class="fc">&nbsp;            adminMessage.setFromUserId(adminUser.get().getId());</b>
<b class="fc">&nbsp;            adminMessage.setToUserId(userId);</b>
<b class="fc">&nbsp;            adminMessage.setMessageType(AdminMessage.MessageType.PRIVATE);</b>
<b class="fc">&nbsp;            adminMessage.setSubject(title);</b>
<b class="fc">&nbsp;            adminMessage.setContent(content);</b>
<b class="fc">&nbsp;            adminMessage.setIsRead(false);</b>
&nbsp;            
<b class="fc">&nbsp;            adminMessageRepository.save(adminMessage);</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;消息发送成功: 从用户 {} 发送到用户 {}&quot;, adminUser.get().getId(), userId);</b>
<b class="fc">&nbsp;            return ResponseEntity.ok(&quot;消息发送成功&quot;);</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;发送消息失败: {}&quot;, e.getMessage(), e);</b>
<b class="nc">&nbsp;            return ResponseEntity.status(500).body(&quot;发送消息失败&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(summary = &quot;更新用户权限&quot;, description = &quot;更新指定用户的权限&quot;)
&nbsp;    @PutMapping(&quot;/users/{userId}/permissions&quot;)
&nbsp;    public ResponseEntity&lt;String&gt; updateUserPermissions(
&nbsp;            @PathVariable Long userId,
&nbsp;            @RequestBody Map&lt;String, Boolean&gt; permissions) {
&nbsp;        
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;管理员更新用户 {} 的权限: {}&quot;, userId, permissions);</b>
&nbsp;            
<b class="pc">&nbsp;            if (permissions == null || permissions.isEmpty()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.badRequest().body(&quot;权限数据不能为空&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 验证用户存在
<b class="fc">&nbsp;            Optional&lt;User&gt; userOpt = userRepository.findById(userId);</b>
<b class="fc">&nbsp;            if (!userOpt.isPresent()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.notFound().build();</b>
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            User user = userOpt.get();</b>
&nbsp;            
&nbsp;            // 将权限转换为JSON字符串保存
<b class="fc">&nbsp;            String permissionsJson = objectToJson(permissions);</b>
<b class="fc">&nbsp;            user.setPermissions(permissionsJson);</b>
&nbsp;            
<b class="fc">&nbsp;            userRepository.save(user);</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;用户 {} 权限更新成功: {}&quot;, userId, permissionsJson);</b>
<b class="fc">&nbsp;            return ResponseEntity.ok(&quot;权限更新成功&quot;);</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;更新用户权限失败: {}&quot;, e.getMessage(), e);</b>
<b class="nc">&nbsp;            return ResponseEntity.status(500).body(&quot;更新权限失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(summary = &quot;批量更新用户权限&quot;, description = &quot;批量更新多个用户的权限&quot;)
&nbsp;    @PutMapping(&quot;/users/permissions&quot;)
&nbsp;    public ResponseEntity&lt;String&gt; updateUsersPermissions(
&nbsp;            @RequestBody UserDTO.BatchPermissionUpdateRequest request) {
&nbsp;        
&nbsp;        // 这里可以实现批量权限更新的逻辑
<b class="fc">&nbsp;        log.info(&quot;批量更新用户权限: {}&quot;, request);</b>
<b class="fc">&nbsp;        return ResponseEntity.ok(&quot;权限更新成功&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Operation(summary = &quot;修改用户角色&quot;, description = &quot;修改指定用户的角色身份&quot;)
&nbsp;    @PutMapping(&quot;/users/{userId}/role&quot;)
&nbsp;    public ResponseEntity&lt;UserDTO.UserResponse&gt; updateUserRole(
&nbsp;            @PathVariable Long userId,
&nbsp;            @Valid @RequestBody UserDTO.UserRoleUpdateRequest request) {
&nbsp;        
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;管理员修改用户 {} 的角色为: {}, 原因: {}&quot;, userId, request.getRole(), request.getReason());</b>
<b class="fc">&nbsp;            UserDTO.UserResponse updatedUser = userService.updateUserRole(userId, request);</b>
<b class="fc">&nbsp;            return ResponseEntity.ok(updatedUser);</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;修改用户角色失败: {}&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(summary = &quot;测试接口&quot;, description = &quot;测试管理员权限和数据库连接&quot;)
&nbsp;    @GetMapping(&quot;/test&quot;)
&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; test() {
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;管理员测试接口被调用&quot;);</b>
&nbsp;            
&nbsp;            // 简单统计用户数
<b class="fc">&nbsp;            UserDTO.UserStatistics stats = userService.getUserStatistics();</b>
&nbsp;            
<b class="fc">&nbsp;            Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            result.put(&quot;message&quot;, &quot;管理员权限正常&quot;);</b>
<b class="fc">&nbsp;            result.put(&quot;totalUsers&quot;, stats.getTotalUsers());</b>
<b class="fc">&nbsp;            result.put(&quot;activeUsers&quot;, stats.getActiveUsers());</b>
<b class="fc">&nbsp;            result.put(&quot;timestamp&quot;, java.time.LocalDateTime.now());</b>
&nbsp;            
<b class="fc">&nbsp;            return ResponseEntity.ok(result);</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;测试接口失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            Map&lt;String, Object&gt; error = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            error.put(&quot;error&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().body(error);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * 客服工作台 - 获取客户对话列表
&nbsp;     */
&nbsp;    @Operation(summary = &quot;获取客户对话列表&quot;, description = &quot;客服工作台获取所有客户对话&quot;)
&nbsp;    @GetMapping(&quot;/support/customer-chats&quot;)
&nbsp;    @PreAuthorize(&quot;hasRole(&#39;support&#39;)&quot;)
&nbsp;    public ResponseEntity&lt;java.util.List&lt;Map&lt;String, Object&gt;&gt;&gt; getCustomerChats() {
&nbsp;        
&nbsp;        try {
&nbsp;            // 获取当前认证信息进行调试
<b class="fc">&nbsp;            Authentication auth = SecurityContextHolder.getContext().getAuthentication();</b>
<b class="fc">&nbsp;            log.info(&quot;客服工作台访问请求:&quot;);</b>
<b class="fc">&nbsp;            log.info(&quot;- 用户名: {}&quot;, auth.getName());</b>
<b class="fc">&nbsp;            log.info(&quot;- 权限列表: {}&quot;, auth.getAuthorities());</b>
<b class="fc">&nbsp;            log.info(&quot;- 是否已认证: {}&quot;, auth.isAuthenticated());</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;开始获取客户对话列表&quot;);</b>
&nbsp;            
&nbsp;            // 获取所有有对话的用户ID列表
<b class="fc">&nbsp;            java.util.List&lt;Long&gt; userIds = supportChatRepository.findDistinctUserIdsOrderByLatestMessage();</b>
&nbsp;            
<b class="fc">&nbsp;            java.util.List&lt;Map&lt;String, Object&gt;&gt; customerChats = new java.util.ArrayList&lt;&gt;();</b>
&nbsp;            
&nbsp;            // 为每个用户创建对话项
<b class="fc">&nbsp;            for (Long userId : userIds) {</b>
&nbsp;                // 获取用户信息
<b class="fc">&nbsp;                Optional&lt;User&gt; userOpt = userRepository.findById(userId);</b>
<b class="pc">&nbsp;                if (!userOpt.isPresent()) continue;</b>
&nbsp;                
<b class="fc">&nbsp;                User user = userOpt.get();</b>
&nbsp;                
&nbsp;                // 获取该用户的所有对话记录
<b class="fc">&nbsp;                java.util.List&lt;SupportChat&gt; userChats = supportChatRepository.findByUserIdOrderByCreatedAtAsc(userId);</b>
<b class="pc">&nbsp;                if (userChats.isEmpty()) continue;</b>
&nbsp;                
&nbsp;                // 获取最新消息
<b class="fc">&nbsp;                SupportChat latestMessage = userChats.get(userChats.size() - 1);</b>
&nbsp;                
&nbsp;                // 统计未读消息数量（用户发送给客服的未读消息）
<b class="fc">&nbsp;                long unreadCount = userChats.stream()</b>
<b class="fc">&nbsp;                        .filter(chat -&gt; chat.getSenderType() == SupportChat.SenderType.USER &amp;&amp; !chat.getIsRead())</b>
<b class="fc">&nbsp;                        .count();</b>
&nbsp;                
<b class="fc">&nbsp;                Map&lt;String, Object&gt; chatInfo = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;                chatInfo.put(&quot;id&quot;, userId);</b>
<b class="fc">&nbsp;                chatInfo.put(&quot;customerId&quot;, userId);</b>
<b class="fc">&nbsp;                chatInfo.put(&quot;customerName&quot;, user.getUsername());</b>
<b class="fc">&nbsp;                chatInfo.put(&quot;customerEmail&quot;, user.getEmail());</b>
<b class="fc">&nbsp;                chatInfo.put(&quot;lastMessage&quot;, latestMessage.getContent());</b>
<b class="fc">&nbsp;                chatInfo.put(&quot;updatedAt&quot;, latestMessage.getCreatedAt());</b>
<b class="fc">&nbsp;                chatInfo.put(&quot;unreadCount&quot;, unreadCount);</b>
&nbsp;                
&nbsp;                // 添加消息列表
<b class="fc">&nbsp;                java.util.List&lt;Map&lt;String, Object&gt;&gt; messages = userChats.stream()</b>
<b class="fc">&nbsp;                        .map(chat -&gt; {</b>
<b class="fc">&nbsp;                            Map&lt;String, Object&gt; messageData = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;                            messageData.put(&quot;id&quot;, chat.getId());</b>
<b class="fc">&nbsp;                            messageData.put(&quot;content&quot;, chat.getContent());</b>
<b class="fc">&nbsp;                            messageData.put(&quot;isFromCustomer&quot;, chat.getSenderType() == SupportChat.SenderType.USER);</b>
<b class="fc">&nbsp;                            messageData.put(&quot;senderType&quot;, chat.getSenderType().name());</b>
<b class="fc">&nbsp;                            messageData.put(&quot;createdAt&quot;, chat.getCreatedAt());</b>
<b class="fc">&nbsp;                            messageData.put(&quot;isRead&quot;, chat.getIsRead());</b>
<b class="fc">&nbsp;                            return messageData;</b>
&nbsp;                        })
<b class="fc">&nbsp;                        .collect(java.util.stream.Collectors.toList());</b>
&nbsp;                
<b class="fc">&nbsp;                chatInfo.put(&quot;messages&quot;, messages);</b>
<b class="fc">&nbsp;                customerChats.add(chatInfo);</b>
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;获取到 {} 个客户对话&quot;, customerChats.size());</b>
<b class="fc">&nbsp;            return ResponseEntity.ok(customerChats);</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;获取客户对话列表失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 客服回复客户
&nbsp;     */
&nbsp;    @Operation(summary = &quot;客服回复客户&quot;, description = &quot;客服向客户发送回复消息&quot;)
&nbsp;    @PostMapping(&quot;/support/reply&quot;)
&nbsp;    @PreAuthorize(&quot;hasRole(&#39;support&#39;)&quot;)
&nbsp;    public ResponseEntity&lt;String&gt; replyToCustomer(@RequestBody Map&lt;String, Object&gt; request) {
&nbsp;        
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;客服回复客户&quot;);</b>
&nbsp;            
<b class="fc">&nbsp;            Long customerId = Long.valueOf(request.get(&quot;customerId&quot;).toString());</b>
<b class="fc">&nbsp;            String content = (String) request.get(&quot;content&quot;);</b>
&nbsp;            
<b class="pc">&nbsp;            if (content == null || content.trim().isEmpty()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.badRequest().body(&quot;回复内容不能为空&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 获取当前客服用户
<b class="fc">&nbsp;            Authentication auth = SecurityContextHolder.getContext().getAuthentication();</b>
<b class="fc">&nbsp;            String supportEmail = auth.getName();</b>
<b class="fc">&nbsp;            Optional&lt;User&gt; supportUser = userRepository.findByEmail(supportEmail);</b>
&nbsp;            
<b class="fc">&nbsp;            if (!supportUser.isPresent()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.status(403).body(&quot;客服用户不存在&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 验证客户存在
<b class="fc">&nbsp;            Optional&lt;User&gt; customer = userRepository.findById(customerId);</b>
<b class="fc">&nbsp;            if (!customer.isPresent()) {</b>
<b class="fc">&nbsp;                return ResponseEntity.badRequest().body(&quot;客户不存在&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 创建客服回复记录
<b class="fc">&nbsp;            SupportChat supportReply = new SupportChat();</b>
<b class="fc">&nbsp;            supportReply.setUserId(customerId);</b>
<b class="fc">&nbsp;            supportReply.setSupportId(supportUser.get().getId());</b>
<b class="fc">&nbsp;            supportReply.setContent(content);</b>
<b class="fc">&nbsp;            supportReply.setSenderType(SupportChat.SenderType.SUPPORT);</b>
<b class="fc">&nbsp;            supportReply.setIsRead(false);</b>
&nbsp;            
<b class="fc">&nbsp;            supportChatRepository.save(supportReply);</b>
&nbsp;            
&nbsp;            // 标记该客户的用户消息为已读
<b class="fc">&nbsp;            java.util.List&lt;SupportChat&gt; userMessages = supportChatRepository.findByUserIdOrderByCreatedAtAsc(customerId);</b>
<b class="pc">&nbsp;            for (SupportChat userMsg : userMessages) {</b>
<b class="nc">&nbsp;                if (userMsg.getSenderType() == SupportChat.SenderType.USER &amp;&amp; !userMsg.getIsRead()) {</b>
<b class="nc">&nbsp;                    userMsg.setIsRead(true);</b>
<b class="nc">&nbsp;                    supportChatRepository.save(userMsg);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;客服 {} 回复客户 {} 成功&quot;, supportUser.get().getUsername(), customer.get().getUsername());</b>
&nbsp;            
<b class="fc">&nbsp;            return ResponseEntity.ok(&quot;回复发送成功&quot;);</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;客服回复失败: {}&quot;, e.getMessage(), e);</b>
<b class="nc">&nbsp;            return ResponseEntity.internalServerError().body(&quot;回复失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 将对象转换为JSON字符串
&nbsp;     */
&nbsp;    private String objectToJson(Object obj) {
&nbsp;        try {
<b class="fc">&nbsp;            return objectMapper.writeValueAsString(obj);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;转换对象到JSON失败: {}&quot;, e.getMessage());</b>
<b class="nc">&nbsp;            return &quot;{}&quot;;</b>
&nbsp;        }
&nbsp;    }
&nbsp;} 
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-18 23:35</div>
</div>
</body>
</html>
