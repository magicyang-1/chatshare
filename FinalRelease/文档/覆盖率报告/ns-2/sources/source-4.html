


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ChatController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.aiplatform.controller</a>
</div>

<h1>Coverage Summary for Class: ChatController (com.aiplatform.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ChatController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (13/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.4%
  </span>
  <span class="absValue">
    (48/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    94.5%
  </span>
  <span class="absValue">
    (156/165)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.aiplatform.controller;
&nbsp;
&nbsp;import com.aiplatform.entity.Chat;
&nbsp;import com.aiplatform.entity.Message;
&nbsp;import com.aiplatform.entity.User;
&nbsp;import com.aiplatform.service.ChatService;
&nbsp;import com.aiplatform.repository.UserRepository;
&nbsp;import com.aiplatform.exception.BusinessException;
&nbsp;import io.swagger.v3.oas.annotations.Operation;
&nbsp;import io.swagger.v3.oas.annotations.tags.Tag;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.core.Authentication;
&nbsp;import org.springframework.security.core.context.SecurityContextHolder;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;@RestController
&nbsp;@RequestMapping(&quot;/chat&quot;)
&nbsp;@RequiredArgsConstructor
&nbsp;@Slf4j
&nbsp;@Tag(name = &quot;聊天管理&quot;, description = &quot;聊天相关接口&quot;)
<b class="fc">&nbsp;public class ChatController {</b>
<b class="fc">&nbsp;</b>
&nbsp;    private final ChatService chatService;
&nbsp;    private final UserRepository userRepository;
&nbsp;
&nbsp;    @Operation(summary = &quot;创建聊天会话&quot;, description = &quot;创建新的聊天会话&quot;)
&nbsp;    @PostMapping(&quot;/create&quot;)
&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; createChat(@RequestBody Map&lt;String, Object&gt; request) {
&nbsp;        try {
&nbsp;            log.info(&quot;创建聊天会话: {}&quot;, request);
&nbsp;            
&nbsp;            // 获取当前用户ID
<b class="fc">&nbsp;            Long userId = getCurrentUserId();</b>
&nbsp;            
&nbsp;            // 解析请求参数
<b class="fc">&nbsp;            String title = (String) request.get(&quot;title&quot;);</b>
&nbsp;            String aiTypeStr = (String) request.get(&quot;aiType&quot;);
&nbsp;            Chat.AiType aiType = Chat.AiType.text_to_text; // 默认值
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;            if (aiTypeStr != null) {</b>
<b class="fc">&nbsp;                try {</b>
<b class="fc">&nbsp;                    aiType = Chat.AiType.valueOf(aiTypeStr);</b>
&nbsp;                } catch (IllegalArgumentException e) {
<b class="fc">&nbsp;                    log.warn(&quot;无效的AI类型: {}, 使用默认值&quot;, aiTypeStr);</b>
&nbsp;                }
<b class="fc">&nbsp;            }</b>
&nbsp;            
<b class="fc">&nbsp;            // 创建聊天会话</b>
&nbsp;            Chat chat = chatService.createChat(userId, title, aiType);
&nbsp;            
&nbsp;            // 准备响应数据
<b class="fc">&nbsp;            Map&lt;String, Object&gt; chatData = new HashMap&lt;&gt;();</b>
&nbsp;            chatData.put(&quot;id&quot;, chat.getId());
&nbsp;            chatData.put(&quot;title&quot;, chat.getTitle());
<b class="fc">&nbsp;            chatData.put(&quot;aiType&quot;, chat.getAiType().name());</b>
&nbsp;            chatData.put(&quot;createdAt&quot;, chat.getCreatedAt());
&nbsp;            chatData.put(&quot;messageCount&quot;, chat.getMessageCount());
<b class="pc">&nbsp;            </b>
<b class="fc">&nbsp;            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</b>
&nbsp;            response.put(&quot;success&quot;, true);
&nbsp;            response.put(&quot;chat&quot;, chatData);
&nbsp;            response.put(&quot;message&quot;, &quot;聊天会话创建成功&quot;);
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;            return ResponseEntity.ok(response);</b>
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;        } catch (BusinessException e) {</b>
<b class="fc">&nbsp;            log.error(&quot;创建聊天会话业务异常: {}&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(createErrorResponse(e.getMessage()));</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
&nbsp;            log.error(&quot;创建聊天会话系统异常: &quot;, e);
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().body(createErrorResponse(&quot;创建聊天会话失败&quot;));</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;    }</b>
<b class="fc">&nbsp;</b>
&nbsp;    @Operation(summary = &quot;发送消息&quot;, description = &quot;向聊天会话发送消息&quot;)
<b class="fc">&nbsp;    @PostMapping(&quot;/{chatId}/message&quot;)</b>
&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; sendMessage(
&nbsp;            @PathVariable Long chatId, 
&nbsp;            @RequestBody Map&lt;String, Object&gt; request) {
<b class="fc">&nbsp;        </b>
&nbsp;        try {
&nbsp;            log.info(&quot;发送消息到聊天 {}: {}&quot;, chatId, request);
<b class="fc">&nbsp;            </b>
&nbsp;            // 获取当前用户ID
&nbsp;            Long userId = getCurrentUserId();
&nbsp;            
&nbsp;            String userMessage = (String) request.get(&quot;content&quot;);
&nbsp;            String roleStr = (String) request.get(&quot;role&quot;);
&nbsp;            
&nbsp;            if (userMessage == null || userMessage.trim().isEmpty()) {
&nbsp;                return ResponseEntity.badRequest().body(createErrorResponse(&quot;消息内容不能为空&quot;));
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;用户消息: {}&quot;, userMessage);</b>
&nbsp;            
&nbsp;            // 保存用户消息
<b class="fc">&nbsp;            Message userMessageEntity = chatService.sendMessage(</b>
&nbsp;                chatId, userId, userMessage, Message.MessageRole.user);
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;            // 生成AI回复</b>
<b class="fc">&nbsp;            String aiResponse = chatService.generateAIResponse(userMessage);</b>
<b class="fc">&nbsp;            </b>
&nbsp;            // 保存AI回复消息
&nbsp;            Message aiMessageEntity = chatService.sendMessage(
&nbsp;                chatId, userId, aiResponse, Message.MessageRole.assistant);
<b class="fc">&nbsp;            </b>
&nbsp;            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
&nbsp;            response.put(&quot;success&quot;, true);
<b class="pc">&nbsp;            response.put(&quot;messageId&quot;, aiMessageEntity.getId());</b>
<b class="fc">&nbsp;            response.put(&quot;response&quot;, aiResponse); // 前端期望的字段名</b>
&nbsp;            response.put(&quot;userMessageId&quot;, userMessageEntity.getId());
&nbsp;            
&nbsp;            return ResponseEntity.ok(response);
<b class="pc">&nbsp;            </b>
<b class="fc">&nbsp;        } catch (BusinessException e) {</b>
&nbsp;            log.error(&quot;发送消息业务异常: {}&quot;, e.getMessage());
&nbsp;            return ResponseEntity.badRequest().body(createErrorResponse(e.getMessage()));
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="pc">&nbsp;            log.error(&quot;发送消息系统异常: &quot;, e);</b>
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().body(createErrorResponse(&quot;发送消息失败&quot;));</b>
&nbsp;        }
&nbsp;    }
<b class="fc">&nbsp;</b>
&nbsp;    @Operation(summary = &quot;获取聊天历史&quot;, description = &quot;获取指定聊天会话的历史消息&quot;)
&nbsp;    @GetMapping(&quot;/{chatId}/messages&quot;)
&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getChatMessages(@PathVariable Long chatId) {
<b class="pc">&nbsp;        try {</b>
<b class="fc">&nbsp;            log.info(&quot;获取聊天历史: {}&quot;, chatId);</b>
&nbsp;            
&nbsp;            // 获取当前用户ID
&nbsp;            Long userId = getCurrentUserId();
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;            // 获取消息列表</b>
<b class="fc">&nbsp;            List&lt;Message&gt; messages = chatService.getChatMessages(chatId, userId);</b>
&nbsp;            
<b class="fc">&nbsp;            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            response.put(&quot;success&quot;, true);</b>
&nbsp;            response.put(&quot;messages&quot;, messages);
<b class="fc">&nbsp;            response.put(&quot;count&quot;, messages.size());</b>
<b class="fc">&nbsp;            </b>
&nbsp;            return ResponseEntity.ok(response);
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;        } catch (BusinessException e) {</b>
&nbsp;            log.error(&quot;获取聊天历史业务异常: {}&quot;, e.getMessage());
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(createErrorResponse(e.getMessage()));</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
&nbsp;            log.error(&quot;获取聊天历史系统异常: &quot;, e);
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().body(createErrorResponse(&quot;获取聊天历史失败&quot;));</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
<b class="fc">&nbsp;</b>
<b class="fc">&nbsp;    @Operation(summary = &quot;删除聊天会话&quot;, description = &quot;删除指定的聊天会话&quot;)</b>
&nbsp;    @DeleteMapping(&quot;/{chatId}&quot;)
&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; deleteChat(@PathVariable Long chatId) {
&nbsp;        try {
<b class="pc">&nbsp;            log.info(&quot;删除聊天会话: {}&quot;, chatId);</b>
<b class="fc">&nbsp;            </b>
&nbsp;            // 获取当前用户ID
&nbsp;            Long userId = getCurrentUserId();
&nbsp;            
<b class="pc">&nbsp;            // 删除聊天会话</b>
<b class="fc">&nbsp;            chatService.deleteChat(chatId, userId);</b>
&nbsp;            
&nbsp;            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
<b class="fc">&nbsp;            response.put(&quot;success&quot;, true);</b>
&nbsp;            response.put(&quot;message&quot;, &quot;聊天会话删除成功&quot;);
&nbsp;            
<b class="fc">&nbsp;            return ResponseEntity.ok(response);</b>
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;        } catch (BusinessException e) {</b>
<b class="fc">&nbsp;            log.error(&quot;删除聊天会话业务异常: {}&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(createErrorResponse(e.getMessage()));</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;删除聊天会话系统异常: &quot;, e);</b>
&nbsp;            return ResponseEntity.internalServerError().body(createErrorResponse(&quot;删除聊天会话失败&quot;));
&nbsp;        }
&nbsp;    }
<b class="fc">&nbsp;</b>
&nbsp;    @Operation(summary = &quot;切换收藏状态&quot;, description = &quot;切换聊天会话的收藏状态&quot;)
&nbsp;    @PatchMapping(&quot;/{chatId}/favorite&quot;)
<b class="fc">&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; toggleFavorite(@PathVariable Long chatId) {</b>
&nbsp;        try {
&nbsp;            log.info(&quot;切换收藏状态: {}&quot;, chatId);
&nbsp;            
&nbsp;            Long userId = getCurrentUserId();
&nbsp;            Chat chat = chatService.toggleFavorite(chatId, userId);
&nbsp;            
&nbsp;            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
<b class="fc">&nbsp;            response.put(&quot;success&quot;, true);</b>
&nbsp;            response.put(&quot;isFavorite&quot;, chat.getIsFavorite());
&nbsp;            response.put(&quot;message&quot;, chat.getIsFavorite() ? &quot;已添加到收藏&quot; : &quot;已取消收藏&quot;);
<b class="fc">&nbsp;            </b>
&nbsp;            return ResponseEntity.ok(response);
&nbsp;            
<b class="fc">&nbsp;        } catch (BusinessException e) {</b>
&nbsp;            log.error(&quot;切换收藏状态业务异常: {}&quot;, e.getMessage());
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(createErrorResponse(e.getMessage()));</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            log.error(&quot;切换收藏状态系统异常: &quot;, e);</b>
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().body(createErrorResponse(&quot;操作失败&quot;));</b>
&nbsp;        }
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Operation(summary = &quot;切换保护状态&quot;, description = &quot;切换聊天会话的保护状态&quot;)
&nbsp;    @PatchMapping(&quot;/{chatId}/protect&quot;)
<b class="fc">&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; toggleProtection(@PathVariable Long chatId) {</b>
&nbsp;        try {
&nbsp;            log.info(&quot;切换保护状态: {}&quot;, chatId);
<b class="nc">&nbsp;            </b>
&nbsp;            Long userId = getCurrentUserId();
&nbsp;            Chat chat = chatService.toggleProtection(chatId, userId);
&nbsp;            
&nbsp;            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
&nbsp;            response.put(&quot;success&quot;, true);
&nbsp;            response.put(&quot;isProtected&quot;, chat.getIsProtected());
&nbsp;            response.put(&quot;message&quot;, chat.getIsProtected() ? &quot;已设为保护对话&quot; : &quot;已取消保护&quot;);
<b class="fc">&nbsp;            </b>
&nbsp;            return ResponseEntity.ok(response);
&nbsp;            
<b class="fc">&nbsp;        } catch (BusinessException e) {</b>
&nbsp;            log.error(&quot;切换保护状态业务异常: {}&quot;, e.getMessage());
&nbsp;            return ResponseEntity.badRequest().body(createErrorResponse(e.getMessage()));
<b class="fc">&nbsp;        } catch (Exception e) {</b>
&nbsp;            log.error(&quot;切换保护状态系统异常: &quot;, e);
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().body(createErrorResponse(&quot;操作失败&quot;));</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
<b class="fc">&nbsp;    @Operation(summary = &quot;更新对话标题&quot;, description = &quot;更新聊天会话的标题&quot;)</b>
&nbsp;    @PatchMapping(&quot;/{chatId}/title&quot;)
&nbsp;    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; updateTitle(
&nbsp;            @PathVariable Long chatId, 
<b class="fc">&nbsp;            @RequestBody Map&lt;String, Object&gt; request) {</b>
&nbsp;        try {
&nbsp;            log.info(&quot;更新对话标题: {}&quot;, chatId);
<b class="nc">&nbsp;            </b>
&nbsp;            Long userId = getCurrentUserId();
&nbsp;            String title = (String) request.get(&quot;title&quot;);
&nbsp;            
&nbsp;            if (title == null || title.trim().isEmpty()) {
&nbsp;                return ResponseEntity.badRequest().body(createErrorResponse(&quot;标题不能为空&quot;));
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            Chat chat = chatService.updateChatTitle(chatId, userId, title);</b>
&nbsp;            
<b class="fc">&nbsp;            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            response.put(&quot;success&quot;, true);</b>
&nbsp;            response.put(&quot;title&quot;, chat.getTitle());
<b class="fc">&nbsp;            response.put(&quot;message&quot;, &quot;标题更新成功&quot;);</b>
<b class="fc">&nbsp;            </b>
<b class="fc">&nbsp;            return ResponseEntity.ok(response);</b>
<b class="pc">&nbsp;            </b>
&nbsp;        } catch (BusinessException e) {
<b class="fc">&nbsp;            log.error(&quot;更新对话标题业务异常: {}&quot;, e.getMessage());</b>
&nbsp;            return ResponseEntity.badRequest().body(createErrorResponse(e.getMessage()));
&nbsp;        } catch (Exception e) {
&nbsp;            log.error(&quot;更新对话标题系统异常: &quot;, e);
<b class="fc">&nbsp;            return ResponseEntity.internalServerError().body(createErrorResponse(&quot;操作失败&quot;));</b>
&nbsp;        }
&nbsp;    }
<b class="nc">&nbsp;</b>
&nbsp;    // 辅助方法：获取当前用户ID
&nbsp;    private Long getCurrentUserId() {
&nbsp;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
&nbsp;        if (authentication == null || !authentication.isAuthenticated()) {
&nbsp;            throw new BusinessException(&quot;用户未登录&quot;);
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        String principal = authentication.getName();</b>
&nbsp;        log.debug(&quot;当前认证主体: {}&quot;, principal);
<b class="fc">&nbsp;        </b>
<b class="fc">&nbsp;        // 首先尝试通过邮箱查找用户，如果失败再尝试用户名</b>
&nbsp;        User user = userRepository.findByEmail(principal)
<b class="fc">&nbsp;            .orElseGet(() -&gt; userRepository.findByUsername(principal)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new BusinessException(&quot;用户不存在: &quot; + principal)));</b>
<b class="fc">&nbsp;        </b>
<b class="pc">&nbsp;        return user.getId();</b>
&nbsp;    }
<b class="fc">&nbsp;</b>
&nbsp;    // 辅助方法：创建错误响应
&nbsp;    private Map&lt;String, Object&gt; createErrorResponse(String message) {
&nbsp;        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
<b class="fc">&nbsp;        response.put(&quot;success&quot;, false);</b>
&nbsp;        response.put(&quot;error&quot;, message);
&nbsp;        return response;
<b class="nc">&nbsp;    }</b>
&nbsp;} 
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-18 23:35</div>
</div>
</body>
</html>
