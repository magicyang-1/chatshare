


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DashScopeImageService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.aiplatform.service</a>
</div>

<h1>Coverage Summary for Class: DashScopeImageService (com.aiplatform.service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DashScopeImageService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (13/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    58.5%
  </span>
  <span class="absValue">
    (55/94)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89.3%
  </span>
  <span class="absValue">
    (191/214)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.aiplatform.service;
&nbsp;
&nbsp;import com.aiplatform.config.AiConfig;
&nbsp;import com.aiplatform.entity.MessageAttachment;
&nbsp;import com.aiplatform.repository.MessageAttachmentRepository;
&nbsp;import com.alibaba.dashscope.aigc.imagesynthesis.ImageSynthesis;
&nbsp;import com.alibaba.dashscope.aigc.imagesynthesis.ImageSynthesisParam;
&nbsp;import com.alibaba.dashscope.aigc.imagesynthesis.ImageSynthesisResult;
&nbsp;import com.alibaba.dashscope.exception.ApiException;
&nbsp;import com.alibaba.dashscope.exception.NoApiKeyException;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.web.multipart.MultipartFile;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.net.URL;
&nbsp;import java.nio.file.Files;
&nbsp;import java.nio.file.Path;
&nbsp;import java.nio.file.Paths;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;import com.aiplatform.entity.Message;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class DashScopeImageService {
&nbsp;
&nbsp;    private final AiConfig aiConfig;
&nbsp;    private final MessageAttachmentRepository messageAttachmentRepository;
&nbsp;
&nbsp;    /**
&nbsp;     * 检查DashScope服务是否可用
&nbsp;     */
&nbsp;    public boolean isAvailable() {
&nbsp;        try {
<b class="fc">&nbsp;            return aiConfig.getDashscope() != null &amp;&amp; </b>
<b class="fc">&nbsp;                   aiConfig.getDashscope().getApiKey() != null &amp;&amp; </b>
<b class="fc">&nbsp;                   !aiConfig.getDashscope().getApiKey().trim().isEmpty();</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;检查DashScope服务可用性失败&quot;, e);</b>
<b class="fc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取支持的图片尺寸列表
&nbsp;     */
&nbsp;    public List&lt;String&gt; getSupportedSizes() {
<b class="fc">&nbsp;        return List.of(&quot;1024*1024&quot;, &quot;720*1280&quot;, &quot;768*1152&quot;, &quot;1280*720&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取支持的图片风格列表
&nbsp;     */
&nbsp;    public List&lt;String&gt; getSupportedStyles() {
<b class="fc">&nbsp;        return List.of(&quot;&lt;auto&gt;&quot;, &quot;&lt;photography&gt;&quot;, &quot;&lt;portrait&gt;&quot;, &quot;&lt;3d cartoon&gt;&quot;, </b>
&nbsp;                      &quot;&lt;anime&gt;&quot;, &quot;&lt;oil painting&gt;&quot;, &quot;&lt;watercolor&gt;&quot;, &quot;&lt;sketch&gt;&quot;, 
&nbsp;                      &quot;&lt;chinese painting&gt;&quot;, &quot;&lt;flat illustration&gt;&quot;);
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 文字生成图像 - Controller接口版本
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public MessageAttachment generateTextToImage(String prompt, String size, String style, Message message) {
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;开始文生图生成，提示词: {}, 尺寸: {}, 风格: {}&quot;, prompt, size, style);</b>
&nbsp;
&nbsp;            // 打印API密钥用于调试
<b class="fc">&nbsp;            String apiKey = aiConfig.getDashscope().getApiKey();</b>
<b class="fc">&nbsp;            log.info(&quot;使用的DashScope API密钥: {}&quot;, apiKey);</b>
<b class="pc">&nbsp;            log.info(&quot;API密钥长度: {}&quot;, apiKey != null ? apiKey.length() : &quot;null&quot;);</b>
&nbsp;
&nbsp;            // 构建参数
<b class="fc">&nbsp;            ImageSynthesisParam param = ImageSynthesisParam.builder()</b>
<b class="fc">&nbsp;                    .apiKey(apiKey)</b>
<b class="fc">&nbsp;                    .model(ImageSynthesis.Models.WANX_V1)</b>
<b class="fc">&nbsp;                    .prompt(prompt)</b>
<b class="pc">&nbsp;                    .style(style != null &amp;&amp; !style.trim().isEmpty() ? style : &quot;&lt;auto&gt;&quot;)</b>
<b class="fc">&nbsp;                    .n(1)</b>
<b class="pc">&nbsp;                    .size(size != null &amp;&amp; !size.trim().isEmpty() ? size : &quot;1024*1024&quot;)</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;
<b class="fc">&nbsp;            ImageSynthesis imageSynthesis = new ImageSynthesis();</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;正在调用DashScope API，请稍候...&quot;);</b>
<b class="fc">&nbsp;            ImageSynthesisResult result = imageSynthesis.call(param);</b>
&nbsp;            
<b class="pc">&nbsp;            if (result == null || result.getOutput() == null) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;DashScope API返回结果为空&quot;);</b>
&nbsp;            }
&nbsp;
&nbsp;            // 检查任务状态
<b class="pc">&nbsp;            if (!&quot;SUCCEEDED&quot;.equals(result.getOutput().getTaskStatus())) {</b>
<b class="nc">&nbsp;                log.error(&quot;图片生成失败，任务状态: {}&quot;, result.getOutput().getTaskStatus());</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;图片生成失败，任务状态: &quot; + result.getOutput().getTaskStatus());</b>
&nbsp;            }
&nbsp;
&nbsp;            // 处理生成的图片
<b class="pc">&nbsp;            if (result.getOutput().getResults() != null &amp;&amp; !result.getOutput().getResults().isEmpty()) {</b>
<b class="fc">&nbsp;                var imageResult = result.getOutput().getResults().get(0);</b>
<b class="fc">&nbsp;                String imageUrl = (String) imageResult.get(&quot;url&quot;);</b>
&nbsp;                
<b class="pc">&nbsp;                if (imageUrl != null &amp;&amp; !imageUrl.isEmpty()) {</b>
<b class="fc">&nbsp;                    log.info(&quot;下载生成的图片: {}&quot;, imageUrl);</b>
&nbsp;                    
&nbsp;                    // 下载并保存图片到本地
<b class="fc">&nbsp;                    String savedImagePath = downloadAndSaveImage(imageUrl);</b>
&nbsp;                    
&nbsp;                    // 创建并保存附件记录
<b class="fc">&nbsp;                    MessageAttachment attachment = new MessageAttachment();</b>
<b class="fc">&nbsp;                    attachment.setMessageId(message.getId());</b>
<b class="fc">&nbsp;                    attachment.setFileName(&quot;generated_&quot; + UUID.randomUUID().toString() + &quot;.png&quot;);</b>
<b class="fc">&nbsp;                    attachment.setFilePath(savedImagePath);</b>
<b class="fc">&nbsp;                    attachment.setMimeType(&quot;image/png&quot;);</b>
<b class="fc">&nbsp;                    attachment.setAttachmentType(MessageAttachment.AttachmentType.IMAGE);</b>
<b class="fc">&nbsp;                    attachment.setFileSize(getFileSize(savedImagePath));</b>
<b class="fc">&nbsp;                    attachment.setCreatedAt(LocalDateTime.now());</b>
&nbsp;                    
<b class="fc">&nbsp;                    MessageAttachment savedAttachment = messageAttachmentRepository.save(attachment);</b>
<b class="fc">&nbsp;                    log.info(&quot;文生图成功生成并保存: {}&quot;, savedImagePath);</b>
&nbsp;                    
<b class="fc">&nbsp;                    return savedAttachment;</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            throw new RuntimeException(&quot;没有生成任何图片&quot;);</b>
&nbsp;            
&nbsp;        } catch (ApiException | NoApiKeyException e) {
<b class="fc">&nbsp;            log.error(&quot;DashScope API调用失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;DashScope API调用失败: &quot; + e.getMessage());</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;文生图处理失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;文生图处理失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 图像生成图像 - Controller接口版本
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public MessageAttachment generateImageToImage(String prompt, String referenceImageUrl, String size, String style, Message message) {
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;开始图生图生成，提示词: {}, 参考图: {}&quot;, prompt, referenceImageUrl);</b>
&nbsp;            
&nbsp;            // 构建参数 - 暂时使用基础文生图功能
&nbsp;            // 注意：当前SDK版本可能不支持图生图，先使用文生图实现
<b class="fc">&nbsp;            String enhancedPrompt = &quot;参考图像风格，&quot; + prompt;</b>
<b class="fc">&nbsp;            ImageSynthesisParam param = ImageSynthesisParam.builder()</b>
<b class="fc">&nbsp;                    .apiKey(aiConfig.getDashscope().getApiKey())</b>
<b class="fc">&nbsp;                    .model(ImageSynthesis.Models.WANX_V1)</b>
<b class="fc">&nbsp;                    .prompt(enhancedPrompt)</b>
<b class="pc">&nbsp;                    .style(style != null &amp;&amp; !style.trim().isEmpty() ? style : &quot;&lt;auto&gt;&quot;)</b>
<b class="fc">&nbsp;                    .n(1)</b>
<b class="pc">&nbsp;                    .size(size != null &amp;&amp; !size.trim().isEmpty() ? size : &quot;1024*1024&quot;)</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;
<b class="fc">&nbsp;            ImageSynthesis imageSynthesis = new ImageSynthesis();</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;正在调用DashScope图生图API，请稍候...&quot;);</b>
<b class="fc">&nbsp;            ImageSynthesisResult result = imageSynthesis.call(param);</b>
&nbsp;            
<b class="pc">&nbsp;            if (result == null || result.getOutput() == null) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;DashScope API返回结果为空&quot;);</b>
&nbsp;            }
&nbsp;
&nbsp;            // 检查任务状态
<b class="pc">&nbsp;            if (!&quot;SUCCEEDED&quot;.equals(result.getOutput().getTaskStatus())) {</b>
<b class="nc">&nbsp;                log.error(&quot;图生图失败，任务状态: {}&quot;, result.getOutput().getTaskStatus());</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;图生图失败，任务状态: &quot; + result.getOutput().getTaskStatus());</b>
&nbsp;            }
&nbsp;
&nbsp;            // 处理生成的图片
<b class="pc">&nbsp;            if (result.getOutput().getResults() != null &amp;&amp; !result.getOutput().getResults().isEmpty()) {</b>
<b class="fc">&nbsp;                var imageResult = result.getOutput().getResults().get(0);</b>
<b class="fc">&nbsp;                String imageUrl = (String) imageResult.get(&quot;url&quot;);</b>
&nbsp;                
<b class="pc">&nbsp;                if (imageUrl != null &amp;&amp; !imageUrl.isEmpty()) {</b>
<b class="fc">&nbsp;                    log.info(&quot;下载生成的图片: {}&quot;, imageUrl);</b>
&nbsp;                    
&nbsp;                    // 下载并保存图片到本地
<b class="fc">&nbsp;                    String savedImagePath = downloadAndSaveImage(imageUrl);</b>
&nbsp;                    
&nbsp;                    // 创建并保存附件记录
<b class="fc">&nbsp;                    MessageAttachment attachment = new MessageAttachment();</b>
<b class="fc">&nbsp;                    attachment.setMessageId(message.getId());</b>
<b class="fc">&nbsp;                    attachment.setFileName(&quot;generated_from_image_&quot; + UUID.randomUUID().toString() + &quot;.png&quot;);</b>
<b class="fc">&nbsp;                    attachment.setFilePath(savedImagePath);</b>
<b class="fc">&nbsp;                    attachment.setMimeType(&quot;image/png&quot;);</b>
<b class="fc">&nbsp;                    attachment.setAttachmentType(MessageAttachment.AttachmentType.IMAGE);</b>
<b class="fc">&nbsp;                    attachment.setFileSize(getFileSize(savedImagePath));</b>
<b class="fc">&nbsp;                    attachment.setCreatedAt(LocalDateTime.now());</b>
&nbsp;                    
<b class="fc">&nbsp;                    MessageAttachment savedAttachment = messageAttachmentRepository.save(attachment);</b>
<b class="fc">&nbsp;                    log.info(&quot;图生图成功生成并保存: {}&quot;, savedImagePath);</b>
&nbsp;                    
<b class="fc">&nbsp;                    return savedAttachment;</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            throw new RuntimeException(&quot;没有生成任何图片&quot;);</b>
&nbsp;            
&nbsp;        } catch (ApiException | NoApiKeyException e) {
<b class="fc">&nbsp;            log.error(&quot;DashScope图生图API调用失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;DashScope图生图API调用失败: &quot; + e.getMessage());</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;图生图处理失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;图生图处理失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 文字生成图像 (Text-to-Image) - 原始方法保留
&nbsp;     * 基于阿里云DashScope官方文档实现
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public List&lt;String&gt; generateImageFromText(String prompt, Long messageId) {
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;开始文生图生成，提示词: {}&quot;, prompt);</b>
&nbsp;
&nbsp;            // 构建参数 - 严格按照官方文档格式
<b class="fc">&nbsp;            ImageSynthesisParam param = ImageSynthesisParam.builder()</b>
<b class="fc">&nbsp;                    .apiKey(aiConfig.getDashscope().getApiKey())</b>
<b class="fc">&nbsp;                    .model(ImageSynthesis.Models.WANX_V1)  // 使用官方模型常量</b>
<b class="fc">&nbsp;                    .prompt(prompt)</b>
<b class="fc">&nbsp;                    .style(&quot;&lt;auto&gt;&quot;)  // 默认风格，可以根据需要调整</b>
<b class="fc">&nbsp;                    .n(1)  // 生成1张图片</b>
<b class="fc">&nbsp;                    .size(&quot;1024*1024&quot;)  // 官方文档中的格式</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;
<b class="fc">&nbsp;            ImageSynthesis imageSynthesis = new ImageSynthesis();</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;正在调用DashScope API，请稍候...&quot;);</b>
<b class="fc">&nbsp;            ImageSynthesisResult result = imageSynthesis.call(param);</b>
&nbsp;            
<b class="pc">&nbsp;            if (result == null || result.getOutput() == null) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;DashScope API返回结果为空&quot;);</b>
&nbsp;            }
&nbsp;
&nbsp;            // 检查任务状态
<b class="pc">&nbsp;            if (!&quot;SUCCEEDED&quot;.equals(result.getOutput().getTaskStatus())) {</b>
<b class="nc">&nbsp;                log.error(&quot;图片生成失败，任务状态: {}&quot;, result.getOutput().getTaskStatus());</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;图片生成失败，任务状态: &quot; + result.getOutput().getTaskStatus());</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            List&lt;String&gt; generatedImagePaths = new ArrayList&lt;&gt;();</b>
&nbsp;            
&nbsp;            // 处理生成的图片 - 按照官方文档的结果结构
<b class="pc">&nbsp;            if (result.getOutput().getResults() != null) {</b>
<b class="fc">&nbsp;                for (var imageResult : result.getOutput().getResults()) {</b>
<b class="fc">&nbsp;                    String imageUrl = (String) imageResult.get(&quot;url&quot;);</b>
&nbsp;                    
<b class="pc">&nbsp;                    if (imageUrl != null &amp;&amp; !imageUrl.isEmpty()) {</b>
<b class="fc">&nbsp;                        log.info(&quot;下载生成的图片: {}&quot;, imageUrl);</b>
&nbsp;                        
&nbsp;                        // 下载并保存图片到本地
<b class="fc">&nbsp;                        String savedImagePath = downloadAndSaveImage(imageUrl);</b>
&nbsp;                        
&nbsp;                        // 保存到数据库
<b class="pc">&nbsp;                        if (messageId != null) {</b>
<b class="fc">&nbsp;                            MessageAttachment attachment = new MessageAttachment();</b>
<b class="fc">&nbsp;                            attachment.setMessageId(messageId);</b>
<b class="fc">&nbsp;                            attachment.setFileName(&quot;generated_&quot; + UUID.randomUUID().toString() + &quot;.png&quot;);</b>
<b class="fc">&nbsp;                            attachment.setFilePath(savedImagePath);</b>
<b class="fc">&nbsp;                            attachment.setMimeType(&quot;image/png&quot;);</b>
<b class="fc">&nbsp;                            attachment.setAttachmentType(MessageAttachment.AttachmentType.IMAGE);</b>
<b class="fc">&nbsp;                            attachment.setFileSize(getFileSize(savedImagePath));</b>
<b class="fc">&nbsp;                            attachment.setCreatedAt(LocalDateTime.now());</b>
&nbsp;                            
<b class="fc">&nbsp;                            messageAttachmentRepository.save(attachment);</b>
&nbsp;                        }
&nbsp;                        
<b class="fc">&nbsp;                        generatedImagePaths.add(savedImagePath);</b>
<b class="fc">&nbsp;                        log.info(&quot;文生图成功生成并保存: {}&quot;, savedImagePath);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;            
<b class="pc">&nbsp;            if (generatedImagePaths.isEmpty()) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;没有生成任何图片&quot;);</b>
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;文生图完成，共生成 {} 张图片&quot;, generatedImagePaths.size());</b>
<b class="fc">&nbsp;            return generatedImagePaths;</b>
&nbsp;            
&nbsp;        } catch (ApiException | NoApiKeyException e) {
<b class="nc">&nbsp;            log.error(&quot;DashScope API调用失败: {}&quot;, e.getMessage(), e);</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;DashScope API调用失败: &quot; + e.getMessage());</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;文生图处理失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;文生图处理失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 图像生成图像 (Image-to-Image) - 原始方法保留
&nbsp;     * 使用参考图和提示词生成新图像
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public List&lt;String&gt; generateImageFromImage(MultipartFile inputImage, String prompt, Long messageId) {
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;开始图生图生成，提示词: {}&quot;, prompt);</b>
&nbsp;
&nbsp;            // 首先保存输入图片并获取URL
<b class="fc">&nbsp;            String inputImagePath = saveUploadedImage(inputImage);</b>
&nbsp;            // 注意：这里需要转换为可访问的HTTP URL，实际项目中可能需要上传到OSS等
<b class="fc">&nbsp;            String refImageUrl = convertToAccessibleUrl(inputImagePath);</b>
&nbsp;            
&nbsp;            // 构建参数 - 暂时使用基础文生图功能
&nbsp;            // 注意：当前SDK版本可能不支持图生图，先使用文生图实现
<b class="fc">&nbsp;            String enhancedPrompt = &quot;基于输入图像的风格和内容，&quot; + prompt;</b>
<b class="fc">&nbsp;            ImageSynthesisParam param = ImageSynthesisParam.builder()</b>
<b class="fc">&nbsp;                    .apiKey(aiConfig.getDashscope().getApiKey())</b>
<b class="fc">&nbsp;                    .model(ImageSynthesis.Models.WANX_V1)</b>
<b class="fc">&nbsp;                    .prompt(enhancedPrompt)</b>
<b class="fc">&nbsp;                    .style(&quot;&lt;auto&gt;&quot;)</b>
<b class="fc">&nbsp;                    .n(1)</b>
<b class="fc">&nbsp;                    .size(&quot;1024*1024&quot;)</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;
<b class="fc">&nbsp;            ImageSynthesis imageSynthesis = new ImageSynthesis();</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;正在调用DashScope图生图API，请稍候...&quot;);</b>
<b class="fc">&nbsp;            ImageSynthesisResult result = imageSynthesis.call(param);</b>
&nbsp;            
<b class="pc">&nbsp;            if (result == null || result.getOutput() == null) {</b>
<b class="fc">&nbsp;                throw new RuntimeException(&quot;DashScope API返回结果为空&quot;);</b>
&nbsp;            }
&nbsp;
&nbsp;            // 检查任务状态
<b class="pc">&nbsp;            if (!&quot;SUCCEEDED&quot;.equals(result.getOutput().getTaskStatus())) {</b>
<b class="nc">&nbsp;                log.error(&quot;图生图失败，任务状态: {}&quot;, result.getOutput().getTaskStatus());</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;图生图失败，任务状态: &quot; + result.getOutput().getTaskStatus());</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            List&lt;String&gt; generatedImagePaths = new ArrayList&lt;&gt;();</b>
&nbsp;            
&nbsp;            // 处理生成的图片
<b class="pc">&nbsp;            if (result.getOutput().getResults() != null) {</b>
<b class="fc">&nbsp;                for (var imageResult : result.getOutput().getResults()) {</b>
<b class="fc">&nbsp;                    String imageUrl = (String) imageResult.get(&quot;url&quot;);</b>
&nbsp;                    
<b class="pc">&nbsp;                    if (imageUrl != null &amp;&amp; !imageUrl.isEmpty()) {</b>
<b class="fc">&nbsp;                        log.info(&quot;下载生成的图片: {}&quot;, imageUrl);</b>
&nbsp;                        
&nbsp;                        // 下载并保存图片到本地
<b class="fc">&nbsp;                        String savedImagePath = downloadAndSaveImage(imageUrl);</b>
&nbsp;                        
&nbsp;                        // 保存到数据库
<b class="pc">&nbsp;                        if (messageId != null) {</b>
<b class="fc">&nbsp;                            MessageAttachment attachment = new MessageAttachment();</b>
<b class="fc">&nbsp;                            attachment.setMessageId(messageId);</b>
<b class="fc">&nbsp;                            attachment.setFileName(&quot;generated_from_image_&quot; + UUID.randomUUID().toString() + &quot;.png&quot;);</b>
<b class="fc">&nbsp;                            attachment.setFilePath(savedImagePath);</b>
<b class="fc">&nbsp;                            attachment.setMimeType(&quot;image/png&quot;);</b>
<b class="fc">&nbsp;                            attachment.setAttachmentType(MessageAttachment.AttachmentType.IMAGE);</b>
<b class="fc">&nbsp;                            attachment.setFileSize(getFileSize(savedImagePath));</b>
<b class="fc">&nbsp;                            attachment.setCreatedAt(LocalDateTime.now());</b>
&nbsp;                            
<b class="fc">&nbsp;                            messageAttachmentRepository.save(attachment);</b>
&nbsp;                        }
&nbsp;                        
<b class="fc">&nbsp;                        generatedImagePaths.add(savedImagePath);</b>
<b class="fc">&nbsp;                        log.info(&quot;图生图成功生成并保存: {}&quot;, savedImagePath);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;            
<b class="pc">&nbsp;            if (generatedImagePaths.isEmpty()) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;没有生成任何图片&quot;);</b>
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;图生图完成，共生成 {} 张图片&quot;, generatedImagePaths.size());</b>
<b class="fc">&nbsp;            return generatedImagePaths;</b>
&nbsp;            
&nbsp;        } catch (ApiException | NoApiKeyException e) {
<b class="nc">&nbsp;            log.error(&quot;DashScope图生图API调用失败: {}&quot;, e.getMessage(), e);</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;DashScope图生图API调用失败: &quot; + e.getMessage());</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;图生图处理失败: {}&quot;, e.getMessage(), e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;图生图处理失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 下载并保存生成的图片
&nbsp;     * 图片URL有效期24小时，需要及时下载保存
&nbsp;     */
&nbsp;    private String downloadAndSaveImage(String imageUrl) throws IOException {
&nbsp;        try {
&nbsp;            // 创建生成图片目录
<b class="fc">&nbsp;            String uploadDir = &quot;uploads/generated&quot;;</b>
<b class="fc">&nbsp;            Path uploadPath = Paths.get(uploadDir);</b>
<b class="fc">&nbsp;            if (!Files.exists(uploadPath)) {</b>
<b class="fc">&nbsp;                Files.createDirectories(uploadPath);</b>
&nbsp;            }
&nbsp;
&nbsp;            // 生成唯一文件名
<b class="fc">&nbsp;            String fileName = &quot;generated_&quot; + UUID.randomUUID().toString() + &quot;.png&quot;;</b>
<b class="fc">&nbsp;            Path filePath = uploadPath.resolve(fileName);</b>
&nbsp;
&nbsp;            // 下载图片 - 按照官方文档说明，图片存储在阿里云OSS
<b class="fc">&nbsp;            URL url = new URL(imageUrl);</b>
<b class="fc">&nbsp;            try (InputStream in = url.openStream()) {</b>
<b class="fc">&nbsp;                Files.copy(in, filePath);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            log.info(&quot;图片下载成功: {} -&gt; {}&quot;, imageUrl, filePath);</b>
<b class="fc">&nbsp;            return filePath.toString();</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;下载图片失败: {}&quot;, imageUrl, e);</b>
<b class="nc">&nbsp;            throw new IOException(&quot;下载图片失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 保存上传的参考图片
&nbsp;     */
&nbsp;    private String saveUploadedImage(MultipartFile file) throws IOException {
&nbsp;        try {
&nbsp;            // 创建输入图片目录
<b class="fc">&nbsp;            String uploadDir = &quot;uploads/input&quot;;</b>
<b class="fc">&nbsp;            Path uploadPath = Paths.get(uploadDir);</b>
<b class="fc">&nbsp;            if (!Files.exists(uploadPath)) {</b>
<b class="fc">&nbsp;                Files.createDirectories(uploadPath);</b>
&nbsp;            }
&nbsp;
&nbsp;            // 生成唯一文件名
<b class="fc">&nbsp;            String originalFilename = file.getOriginalFilename();</b>
<b class="pc">&nbsp;            String extension = originalFilename != null &amp;&amp; originalFilename.contains(&quot;.&quot;) </b>
<b class="fc">&nbsp;                    ? originalFilename.substring(originalFilename.lastIndexOf(&quot;.&quot;)) </b>
<b class="fc">&nbsp;                    : &quot;.png&quot;;</b>
<b class="fc">&nbsp;            String fileName = &quot;input_&quot; + UUID.randomUUID().toString() + extension;</b>
<b class="fc">&nbsp;            Path filePath = uploadPath.resolve(fileName);</b>
&nbsp;
&nbsp;            // 保存文件
<b class="fc">&nbsp;            Files.copy(file.getInputStream(), filePath);</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;参考图片保存成功: {}&quot;, filePath);</b>
<b class="fc">&nbsp;            return filePath.toString();</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;保存上传图片失败&quot;, e);</b>
<b class="fc">&nbsp;            throw new IOException(&quot;保存上传图片失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 将本地文件路径转换为可访问的URL
&nbsp;     * 注意：实际项目中可能需要上传到OSS等云存储服务
&nbsp;     */
&nbsp;    private String convertToAccessibleUrl(String localPath) {
&nbsp;        // 这里是简化实现，实际项目中需要：
&nbsp;        // 1. 上传到阿里云OSS或其他云存储
&nbsp;        // 2. 返回公开可访问的HTTP URL
&nbsp;        
&nbsp;        // 临时解决方案：返回本地HTTP服务器路径
&nbsp;        // 需要确保这个URL可以被DashScope服务访问到
<b class="fc">&nbsp;        return &quot;http://localhost:8080/files/&quot; + Paths.get(localPath).getFileName().toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取文件大小
&nbsp;     */
&nbsp;    private Long getFileSize(String filePath) {
&nbsp;        try {
<b class="fc">&nbsp;            return Files.size(Paths.get(filePath));</b>
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            log.warn(&quot;获取文件大小失败: {}&quot;, filePath);</b>
<b class="nc">&nbsp;            return 0L;</b>
&nbsp;        }
&nbsp;    }
&nbsp;} 
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-18 23:35</div>
</div>
</body>
</html>
