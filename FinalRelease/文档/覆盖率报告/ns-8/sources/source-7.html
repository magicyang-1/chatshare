


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > Meshy3DService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.aiplatform.service</a>
</div>

<h1>Coverage Summary for Class: Meshy3DService (com.aiplatform.service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Meshy3DService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    70%
  </span>
  <span class="absValue">
    (28/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    86.4%
  </span>
  <span class="absValue">
    (89/103)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.aiplatform.service;
&nbsp;import java.net.URI;
&nbsp;import java.net.http.HttpClient;
&nbsp;import java.net.http.HttpRequest;
&nbsp;import java.net.http.HttpResponse;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;import com.aiplatform.dto.AIResponseDTO;
&nbsp;import com.aiplatform.dto.ThreeDRecordDTO;
&nbsp;import com.aiplatform.entity.Chat;
&nbsp;import com.aiplatform.entity.Message;
&nbsp;import com.aiplatform.entity.MessageAttachment;
&nbsp;import com.aiplatform.entity.User;
&nbsp;import com.aiplatform.repository.MessageAttachmentRepository;
&nbsp;import com.aiplatform.repository.ChatRepository;
&nbsp;import com.aiplatform.repository.MessageRepository;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
<b class="fc">&nbsp;public class Meshy3DService {</b>
&nbsp;    private static final String API_KEY = &quot;msy_jnQVeA6HLxoDIDLs8w8iunn887KQZTzVy7uo&quot;;
&nbsp;    private static final String BASE_URL = &quot;https://api.meshy.ai/openapi/v2&quot;;
&nbsp;
<b class="fc">&nbsp;    private final HttpClient client = HttpClient.newHttpClient();</b>
<b class="fc">&nbsp;    private final ObjectMapper objectMapper = new ObjectMapper();</b>
&nbsp;    
&nbsp;    @Autowired
&nbsp;    private MessageAttachmentRepository messageAttachmentRepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ChatRepository chatRepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private MessageRepository messageRepository;
&nbsp;
&nbsp;    /**
&nbsp;     * 从JSON响应中提取result字段
&nbsp;     */
&nbsp;    private String extractResultFromResponse(String jsonResponse) throws Exception {
&nbsp;        try {
<b class="fc">&nbsp;            JsonNode jsonNode = objectMapper.readTree(jsonResponse);</b>
<b class="fc">&nbsp;            if (jsonNode.has(&quot;result&quot;)) {</b>
<b class="fc">&nbsp;                return jsonNode.get(&quot;result&quot;).asText();</b>
&nbsp;            } else {
<b class="fc">&nbsp;                log.warn(&quot;响应中没有找到result字段: {}&quot;, jsonResponse);</b>
<b class="fc">&nbsp;                return jsonResponse; // 如果没有result字段，返回原始响应</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;解析JSON响应失败: {}&quot;, jsonResponse, e);</b>
<b class="fc">&nbsp;            throw new RuntimeException(&quot;解析响应失败: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * 创建一个 Text to 3D 任务
&nbsp;     */
&nbsp;    public String createTextTo3D(String prompt, String mode, String art_style, Boolean should_remesh, Integer seed, Message message) throws Exception {
&nbsp;        // 清理输入参数，移除特殊字符
<b class="pc">&nbsp;        String cleanPrompt = prompt != null ? prompt.replaceAll(&quot;[\\u00A0\\u2000-\\u200F\\u2028-\\u202F\\u205F-\\u206F]&quot;, &quot; &quot;).trim() : &quot;&quot;;</b>
<b class="pc">&nbsp;        String cleanMode = mode != null ? mode.replaceAll(&quot;[\\u00A0\\u2000-\\u200F\\u2028-\\u202F\\u205F-\\u206F]&quot;, &quot; &quot;).trim() : &quot;&quot;;</b>
<b class="pc">&nbsp;        String cleanArtStyle = art_style != null ? art_style.replaceAll(&quot;[\\u00A0\\u2000-\\u200F\\u2028-\\u202F\\u205F-\\u206F]&quot;, &quot; &quot;).trim() : &quot;&quot;;</b>
&nbsp;
&nbsp;        // 使用StringBuilder构建JSON，避免格式化问题
<b class="fc">&nbsp;        StringBuilder jsonBuilder = new StringBuilder();</b>
<b class="fc">&nbsp;        jsonBuilder.append(&quot;{&quot;);</b>
<b class="fc">&nbsp;        jsonBuilder.append(&quot;\&quot;prompt\&quot;:\&quot;&quot;).append(cleanPrompt).append(&quot;\&quot;,&quot;);</b>
<b class="fc">&nbsp;        jsonBuilder.append(&quot;\&quot;mode\&quot;:\&quot;&quot;).append(cleanMode).append(&quot;\&quot;,&quot;);</b>
<b class="fc">&nbsp;        jsonBuilder.append(&quot;\&quot;art_style\&quot;:\&quot;&quot;).append(cleanArtStyle).append(&quot;\&quot;,&quot;);</b>
<b class="pc">&nbsp;        jsonBuilder.append(&quot;\&quot;should_remesh\&quot;:&quot;).append(should_remesh != null ? should_remesh : false).append(&quot;,&quot;);</b>
<b class="pc">&nbsp;        jsonBuilder.append(&quot;\&quot;seed\&quot;:&quot;).append(seed != null ? seed : 0);</b>
<b class="fc">&nbsp;        jsonBuilder.append(&quot;}&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        String json = jsonBuilder.toString();</b>
&nbsp;
&nbsp;        // 添加调试日志
<b class="fc">&nbsp;        log.info(&quot;Generated JSON: {}&quot;, json);</b>
<b class="fc">&nbsp;        System.out.println(json);</b>
&nbsp;
<b class="fc">&nbsp;        HttpRequest req = HttpRequest.newBuilder()</b>
<b class="fc">&nbsp;                .uri(URI.create(BASE_URL + &quot;/text-to-3d&quot;))</b>
<b class="fc">&nbsp;                .header(&quot;Authorization&quot;, &quot;Bearer &quot; + API_KEY)</b>
<b class="fc">&nbsp;                .header(&quot;Content-Type&quot;, &quot;application/json&quot;)</b>
<b class="fc">&nbsp;                .POST(HttpRequest.BodyPublishers.ofString(json))</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;
<b class="fc">&nbsp;        HttpResponse&lt;String&gt; resp = client.send(req, HttpResponse.BodyHandlers.ofString());</b>
&nbsp;
<b class="pc">&nbsp;        if (resp.statusCode() == 200 || resp.statusCode() == 202) {</b>
&nbsp;            // 提取result字段
<b class="fc">&nbsp;            String taskId = extractResultFromResponse(resp.body());</b>
&nbsp;
&nbsp;            // 创建并保存附件记录
<b class="fc">&nbsp;            MessageAttachment attachment = new MessageAttachment();</b>
<b class="fc">&nbsp;            attachment.setMessageId(message.getId());</b>
<b class="fc">&nbsp;            attachment.setFileName(&quot;preview_&quot; + art_style+ &#39;_&#39; + UUID.randomUUID().toString() + &quot;task&quot;);</b>
<b class="fc">&nbsp;            attachment.setFilePath(taskId); // 使用taskId作为文件路径</b>
<b class="fc">&nbsp;            attachment.setMimeType(&quot;3d/preview&quot;);</b>
<b class="fc">&nbsp;            attachment.setAttachmentType(MessageAttachment.AttachmentType.OTHER);</b>
<b class="fc">&nbsp;            attachment.setFileSize(0L);</b>
<b class="fc">&nbsp;            attachment.setCreatedAt(LocalDateTime.now());</b>
&nbsp;
<b class="fc">&nbsp;            MessageAttachment savedAttachment = messageAttachmentRepository.save(attachment);</b>
<b class="fc">&nbsp;            log.info(&quot;文生3d成功生成并保存: {}&quot;, taskId);</b>
<b class="fc">&nbsp;            return resp.body();</b>
&nbsp;        }
&nbsp;             else {
<b class="nc">&nbsp;                throw new RuntimeException(&quot;创建任务失败：&quot; + resp.statusCode() + &quot; / &quot; + resp.body());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;    public String refineTextTo3D(String taskId,String prompt,Message message) throws Exception {
<b class="fc">&nbsp;        String json = &quot;&quot;&quot;</b>
&nbsp;            {
&nbsp;                &quot;mode&quot;: &quot;refine&quot;,
&nbsp;                &quot;preview_task_id&quot;: &quot;%s&quot;,
&nbsp;                &quot;prompt&quot;: &quot;%s&quot;
&nbsp;            }
<b class="fc">&nbsp;            &quot;&quot;&quot;.formatted(taskId,prompt);</b>
<b class="fc">&nbsp;        HttpRequest req = HttpRequest.newBuilder()</b>
<b class="fc">&nbsp;            .uri(URI.create(BASE_URL + &quot;/text-to-3d&quot;))</b>
<b class="fc">&nbsp;            .header(&quot;Authorization&quot;, &quot;Bearer &quot; + API_KEY)</b>
<b class="fc">&nbsp;            .header(&quot;Content-Type&quot;, &quot;application/json&quot;)</b>
<b class="fc">&nbsp;            .POST(HttpRequest.BodyPublishers.ofString(json))</b>
<b class="fc">&nbsp;            .build();</b>
<b class="fc">&nbsp;        HttpResponse&lt;String&gt; resp = client.send(req, HttpResponse.BodyHandlers.ofString());</b>
<b class="pc">&nbsp;        if (resp.statusCode() == 200 || resp.statusCode() == 202) {</b>
&nbsp;            // 提取result字段
<b class="nc">&nbsp;            String taskId2 = extractResultFromResponse(resp.body());</b>
&nbsp;
&nbsp;            // 创建并保存附件记录
<b class="nc">&nbsp;            MessageAttachment attachment = new MessageAttachment();</b>
<b class="nc">&nbsp;            attachment.setMessageId(message.getId());</b>
<b class="nc">&nbsp;            attachment.setFileName(&quot;refine_&quot; + &quot;refine_&quot; + UUID.randomUUID().toString() + &quot;task&quot;);</b>
<b class="nc">&nbsp;            attachment.setFilePath(taskId2); // 使用taskId作为文件路径</b>
<b class="nc">&nbsp;            attachment.setMimeType(&quot;3d/refine&quot;);</b>
<b class="nc">&nbsp;            attachment.setAttachmentType(MessageAttachment.AttachmentType.OTHER);</b>
<b class="nc">&nbsp;            attachment.setFileSize(0L);</b>
<b class="nc">&nbsp;            attachment.setCreatedAt(LocalDateTime.now());</b>
&nbsp;
<b class="nc">&nbsp;            MessageAttachment savedAttachment = messageAttachmentRepository.save(attachment);</b>
<b class="nc">&nbsp;            log.info(&quot;文生3d成功精炼并保存: {}&quot;, taskId2);</b>
<b class="nc">&nbsp;            return resp.body();</b>
&nbsp;        } else {
<b class="fc">&nbsp;            throw new RuntimeException(&quot;细化任务失败：&quot; + resp.statusCode() + &quot; / &quot; + resp.body());</b>
&nbsp;        }
&nbsp;    }
&nbsp;    /**
&nbsp;     * 查询TextTo3D任务
&nbsp;     */
&nbsp;    public String getTextTo3DStatus(String taskId) throws Exception {
<b class="fc">&nbsp;        HttpRequest req = HttpRequest.newBuilder()</b>
<b class="fc">&nbsp;            .uri(URI.create(BASE_URL + &quot;/text-to-3d/&quot; + taskId))</b>
<b class="fc">&nbsp;            .header(&quot;Authorization&quot;, &quot;Bearer &quot; + API_KEY)</b>
<b class="fc">&nbsp;            .GET()</b>
<b class="fc">&nbsp;            .build();</b>
&nbsp;
<b class="fc">&nbsp;        HttpResponse&lt;String&gt; resp = client.send(req, HttpResponse.BodyHandlers.ofString());</b>
<b class="pc">&nbsp;        if (resp.statusCode() == 200 || resp.statusCode() == 202) {</b>
<b class="nc">&nbsp;            return resp.body();</b>
&nbsp;        } else {
<b class="fc">&nbsp;            throw new RuntimeException(&quot;查询任务失败：&quot; + resp.statusCode());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    //搜索历史
&nbsp;    public List&lt;ThreeDRecordDTO&gt; searchHistory(Long id) throws Exception {
<b class="fc">&nbsp;        List&lt;Chat&gt; chats = chatRepository.findByUserIdOrderByLastActivityDesc(id);</b>
<b class="fc">&nbsp;        if (chats.isEmpty()) {</b>
<b class="fc">&nbsp;            return new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        List&lt;ThreeDRecordDTO&gt; history = new ArrayList&lt;&gt;();</b>
&nbsp;        
<b class="fc">&nbsp;        for (Chat chat : chats) {</b>
<b class="fc">&nbsp;            List&lt;Message&gt; messages = messageRepository.findByChatIdOrderByCreatedAtAsc(chat.getId());</b>
&nbsp;            
<b class="fc">&nbsp;            for (Message message : messages) {</b>
<b class="fc">&nbsp;                List&lt;MessageAttachment&gt; attachments = messageAttachmentRepository.findByMessageIdOrderByCreatedAtAsc(message.getId());</b>
&nbsp;                
<b class="fc">&nbsp;                for(MessageAttachment attachment : attachments) {</b>
<b class="fc">&nbsp;                    if(!attachment.getMimeType().equals(&quot;3d/preview&quot;) &amp;&amp; !attachment.getMimeType().equals(&quot;3d/refine&quot;)) {</b>
&nbsp;                        continue;
&nbsp;                    }
&nbsp;                    
<b class="fc">&nbsp;                    ThreeDRecordDTO threeDRecordDTO = new ThreeDRecordDTO();</b>
&nbsp;                    //唯一标识
<b class="fc">&nbsp;                    threeDRecordDTO.setId(attachment.getFilePath());</b>
&nbsp;                    //提示词
<b class="fc">&nbsp;                    threeDRecordDTO.setPrompt(message.getContent());</b>
&nbsp;                    //preview or refine
<b class="fc">&nbsp;                    String mode = attachment.getMimeType().split(&quot;/&quot;)[1];</b>
<b class="fc">&nbsp;                    String art_style = attachment.getFileName().split(&quot;_&quot;)[1];</b>
<b class="fc">&nbsp;                    LocalDateTime created_at = attachment.getCreatedAt();</b>
<b class="fc">&nbsp;                    if(mode.equals(&quot;preview&quot;)) {</b>
<b class="fc">&nbsp;                        mode = &quot;preview&quot;;</b>
<b class="pc">&nbsp;                    } else if(mode.equals(&quot;refine&quot;)) {</b>
<b class="fc">&nbsp;                        mode = &quot;refine&quot;;</b>
&nbsp;                    }
<b class="fc">&nbsp;                    threeDRecordDTO.setMode(mode);</b>
<b class="fc">&nbsp;                    threeDRecordDTO.setArt_style(art_style);</b>
<b class="fc">&nbsp;                    threeDRecordDTO.setCreated_at(created_at);</b>
<b class="fc">&nbsp;                    history.add(threeDRecordDTO);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        return history;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-18 23:35</div>
</div>
</body>
</html>
