


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > UserService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.aiplatform.service</a>
</div>

<h1>Coverage Summary for Class: UserService (com.aiplatform.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">UserService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (15/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    81.4%
  </span>
  <span class="absValue">
    (35/43)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    96.3%
  </span>
  <span class="absValue">
    (155/161)
  </span>
</td>
</tr>
  <tr>
    <td class="name">UserService$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (16/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    81.4%
  </span>
  <span class="absValue">
    (35/43)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    96.3%
  </span>
  <span class="absValue">
    (156/162)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.aiplatform.service;
&nbsp;
&nbsp;import com.aiplatform.dto.UserDTO;
&nbsp;import com.aiplatform.entity.Chat;
&nbsp;import com.aiplatform.entity.User;
&nbsp;import com.aiplatform.exception.BusinessException;
&nbsp;import com.aiplatform.repository.ChatRepository;
&nbsp;import com.aiplatform.repository.MessageRepository;
&nbsp;import com.aiplatform.repository.UserRepository;
&nbsp;import com.aiplatform.security.JwtTokenProvider;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.PageRequest;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.data.domain.Sort;
&nbsp;import org.springframework.security.authentication.AuthenticationManager;
&nbsp;import org.springframework.security.authentication.BadCredentialsException;
&nbsp;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
&nbsp;import org.springframework.security.core.Authentication;
&nbsp;import org.springframework.security.core.AuthenticationException;
&nbsp;import org.springframework.scheduling.annotation.Async;
&nbsp;import org.springframework.security.core.context.SecurityContextHolder;
&nbsp;import org.springframework.security.crypto.password.PasswordEncoder;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Transactional
&nbsp;public class UserService {
&nbsp;
&nbsp;    private final UserRepository userRepository;
&nbsp;    private final ChatRepository chatRepository;
&nbsp;    private final MessageRepository messageRepository;
&nbsp;    private final PasswordEncoder passwordEncoder;
&nbsp;    private final JwtTokenProvider jwtTokenProvider;
&nbsp;    private final AuthenticationManager authenticationManager;
&nbsp;
&nbsp;    /**
&nbsp;     * 用户注册
&nbsp;     */
&nbsp;    public UserDTO.AuthResponse register(UserDTO.UserRegisterRequest request) {
<b class="fc">&nbsp;        log.info(&quot;用户注册请求: email={}, username={}&quot;, request.getEmail(), request.getUsername());</b>
&nbsp;        
&nbsp;        try {
&nbsp;            // 验证密码确认
<b class="fc">&nbsp;            log.debug(&quot;验证密码确认&quot;);</b>
<b class="fc">&nbsp;            if (!request.getPassword().equals(request.getConfirmPassword())) {</b>
<b class="fc">&nbsp;                throw new BusinessException(&quot;两次输入的密码不一致&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 检查邮箱是否已存在
<b class="fc">&nbsp;            log.debug(&quot;检查邮箱是否已存在: {}&quot;, request.getEmail());</b>
<b class="fc">&nbsp;            if (userRepository.existsByEmail(request.getEmail())) {</b>
<b class="fc">&nbsp;                throw new BusinessException(&quot;邮箱已被注册&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 检查用户名是否已存在
<b class="fc">&nbsp;            log.debug(&quot;检查用户名是否已存在: {}&quot;, request.getUsername());</b>
<b class="fc">&nbsp;            if (userRepository.existsByUsername(request.getUsername())) {</b>
<b class="fc">&nbsp;                throw new BusinessException(&quot;用户名已被使用&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 创建用户
<b class="fc">&nbsp;            log.debug(&quot;创建用户对象&quot;);</b>
<b class="fc">&nbsp;            User user = new User();</b>
<b class="fc">&nbsp;            user.setUsername(request.getUsername());</b>
<b class="fc">&nbsp;            user.setEmail(request.getEmail());</b>
<b class="fc">&nbsp;            user.setPassword(passwordEncoder.encode(request.getPassword()));</b>
<b class="fc">&nbsp;            user.setRole(User.UserRole.user);</b>
<b class="fc">&nbsp;            user.setStatus(User.UserStatus.active);</b>
<b class="fc">&nbsp;            user.setPermissions(&quot;CHAT&quot;);</b>
&nbsp;            
<b class="fc">&nbsp;            log.debug(&quot;保存用户到数据库&quot;);</b>
<b class="fc">&nbsp;            user = userRepository.save(user);</b>
<b class="fc">&nbsp;            log.info(&quot;用户保存成功: id={}&quot;, user.getId());</b>
&nbsp;            
&nbsp;            // 生成token
<b class="fc">&nbsp;            log.debug(&quot;生成JWT token&quot;);</b>
<b class="fc">&nbsp;            String token = jwtTokenProvider.generateToken(user.getEmail());</b>
<b class="fc">&nbsp;            String refreshToken = jwtTokenProvider.generateRefreshToken(user.getEmail());</b>
&nbsp;            
<b class="fc">&nbsp;            log.debug(&quot;创建用户响应对象&quot;);</b>
<b class="fc">&nbsp;            UserDTO.UserResponse userResponse = UserDTO.UserResponse.fromEntity(user);</b>
&nbsp;            
<b class="fc">&nbsp;            log.info(&quot;用户注册完全成功: {}&quot;, user.getId());</b>
<b class="fc">&nbsp;            return new UserDTO.AuthResponse(token, refreshToken, userResponse);</b>
&nbsp;            
&nbsp;        } catch (BusinessException e) {
<b class="fc">&nbsp;            log.error(&quot;业务异常: {}&quot;, e.getMessage());</b>
&nbsp;            throw e;
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;注册过程中发生系统异常: &quot;, e);</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 用户登录
&nbsp;     */
&nbsp;    public UserDTO.AuthResponse login(UserDTO.UserLoginRequest request) {
<b class="fc">&nbsp;        log.info(&quot;用户登录请求: {}&quot;, request.getEmail());</b>
&nbsp;        
<b class="fc">&nbsp;        User user = userRepository.findByEmail(request.getEmail())</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new BusinessException(&quot;用户不存在&quot;));</b>
&nbsp;        
&nbsp;        // 检查账户状态
<b class="fc">&nbsp;        if (user.getStatus() != User.UserStatus.active) {</b>
<b class="fc">&nbsp;            throw new BusinessException(&quot;账户已被禁用&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        // 简化的状态检查
<b class="pc">&nbsp;        if (user.getStatus() == User.UserStatus.banned) {</b>
<b class="nc">&nbsp;            throw new BusinessException(&quot;账户已被封禁&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        try {
&nbsp;            // 验证密码
<b class="fc">&nbsp;            Authentication authentication = authenticationManager.authenticate(</b>
<b class="fc">&nbsp;                new UsernamePasswordAuthenticationToken(request.getEmail(), request.getPassword())</b>
&nbsp;            );
&nbsp;            
<b class="fc">&nbsp;            SecurityContextHolder.getContext().setAuthentication(authentication);</b>
&nbsp;            
&nbsp;            // 更新最后登录时间
<b class="fc">&nbsp;            user.setLastLogin(LocalDateTime.now());</b>
<b class="fc">&nbsp;            userRepository.save(user);</b>
&nbsp;            
&nbsp;            // 登录成功后，触发自动清理（异步执行）
<b class="fc">&nbsp;            triggerAutoCleanupForUser(user.getId());</b>
&nbsp;            
&nbsp;            // 生成token
<b class="fc">&nbsp;            String token = jwtTokenProvider.generateToken(user.getEmail());</b>
<b class="fc">&nbsp;            String refreshToken = jwtTokenProvider.generateRefreshToken(user.getEmail());</b>
&nbsp;            
<b class="fc">&nbsp;            UserDTO.UserResponse userResponse = UserDTO.UserResponse.fromEntity(user);</b>
<b class="fc">&nbsp;            log.info(&quot;用户登录成功: {}&quot;, user.getId());</b>
&nbsp;            
<b class="fc">&nbsp;            return new UserDTO.AuthResponse(token, refreshToken, userResponse);</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
&nbsp;            // 简化的错误处理
<b class="fc">&nbsp;            log.warn(&quot;用户登录失败: {}&quot;, user.getEmail());</b>
<b class="fc">&nbsp;            throw new BusinessException(&quot;用户名或密码错误&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 登录时触发自动清理（异步执行）
&nbsp;     */
&nbsp;    @Async
&nbsp;    public void triggerAutoCleanupForUser(Long userId) {
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;开始为用户 {} 执行登录自动清理&quot;, userId);</b>
&nbsp;            
&nbsp;            // 计算30天前的时间
<b class="fc">&nbsp;            LocalDateTime cutoffDate = LocalDateTime.now().minusDays(30);</b>
&nbsp;            
&nbsp;            // 查找需要清理的聊天（非保护且超过30天）
<b class="fc">&nbsp;            List&lt;Chat&gt; chatsToCleanup = chatRepository.findChatsToCleanup(userId, cutoffDate);</b>
&nbsp;            
<b class="fc">&nbsp;            if (!chatsToCleanup.isEmpty()) {</b>
<b class="fc">&nbsp;                int deletedChats = 0;</b>
<b class="fc">&nbsp;                for (Chat chat : chatsToCleanup) {</b>
&nbsp;                    try {
&nbsp;                        // 删除聊天的所有消息
<b class="fc">&nbsp;                        messageRepository.deleteByChatId(chat.getId());</b>
&nbsp;                        // 删除聊天记录
<b class="fc">&nbsp;                        chatRepository.delete(chat);</b>
<b class="fc">&nbsp;                        deletedChats++;</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        log.warn(&quot;删除过期聊天失败 - chatId: {}, error: {}&quot;, chat.getId(), e.getMessage());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                
<b class="fc">&nbsp;                log.info(&quot;用户 {} 登录自动清理完成: 删除了 {} 个过期对话&quot;, userId, deletedChats);</b>
&nbsp;            } else {
<b class="fc">&nbsp;                log.info(&quot;用户 {} 没有需要清理的过期对话&quot;, userId);</b>
&nbsp;            }
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;用户 {} 登录自动清理失败: {}&quot;, userId, e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取当前用户信息
&nbsp;     */
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public UserDTO.UserResponse getCurrentUser() {
<b class="fc">&nbsp;        String email = getCurrentUserEmail();</b>
<b class="fc">&nbsp;        User user = userRepository.findByEmail(email)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new BusinessException(&quot;用户不存在&quot;));</b>
&nbsp;        
<b class="fc">&nbsp;        return UserDTO.UserResponse.fromEntity(user);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 更新用户资料
&nbsp;     */
&nbsp;    public UserDTO.UserResponse updateProfile(UserDTO.UserProfileUpdateRequest request) {
<b class="fc">&nbsp;        String email = getCurrentUserEmail();</b>
<b class="fc">&nbsp;        User user = userRepository.findByEmail(email)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new BusinessException(&quot;用户不存在&quot;));</b>
&nbsp;        
&nbsp;        // 检查用户名是否被其他用户使用
<b class="pc">&nbsp;        if (request.getUsername() != null &amp;&amp; !request.getUsername().equals(user.getUsername())) {</b>
<b class="fc">&nbsp;            if (userRepository.existsByUsername(request.getUsername())) {</b>
<b class="fc">&nbsp;                throw new BusinessException(&quot;用户名已被使用&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            user.setUsername(request.getUsername());</b>
&nbsp;        }
&nbsp;        
<b class="pc">&nbsp;        if (request.getPermissions() != null) {</b>
<b class="fc">&nbsp;            user.setPermissions(request.getPermissions());</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        user = userRepository.save(user);</b>
<b class="fc">&nbsp;        log.info(&quot;用户资料更新成功: {}&quot;, user.getId());</b>
&nbsp;        
<b class="fc">&nbsp;        return UserDTO.UserResponse.fromEntity(user);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 修改密码
&nbsp;     */
&nbsp;    public void changePassword(UserDTO.PasswordChangeRequest request) {
<b class="fc">&nbsp;        if (!request.getNewPassword().equals(request.getConfirmPassword())) {</b>
<b class="fc">&nbsp;            throw new BusinessException(&quot;两次输入的新密码不一致&quot;);</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        String email = getCurrentUserEmail();</b>
<b class="fc">&nbsp;        User user = userRepository.findByEmail(email)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new BusinessException(&quot;用户不存在&quot;));</b>
&nbsp;        
&nbsp;        // 验证当前密码
<b class="fc">&nbsp;        if (!passwordEncoder.matches(request.getCurrentPassword(), user.getPassword())) {</b>
<b class="fc">&nbsp;            throw new BusinessException(&quot;当前密码错误&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        // 检查新密码是否与当前密码相同
<b class="fc">&nbsp;        if (passwordEncoder.matches(request.getNewPassword(), user.getPassword())) {</b>
<b class="fc">&nbsp;            throw new BusinessException(&quot;新密码不能与当前密码相同&quot;);</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        user.setPassword(passwordEncoder.encode(request.getNewPassword()));</b>
<b class="fc">&nbsp;        userRepository.save(user);</b>
&nbsp;        
<b class="fc">&nbsp;        log.info(&quot;用户密码修改成功: {}&quot;, user.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 搜索用户（管理员功能）
&nbsp;     */
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public Page&lt;UserDTO.UserResponse&gt; searchUsers(UserDTO.UserSearchRequest request) {
<b class="fc">&nbsp;        log.info(&quot;=== UserService.searchUsers 开始 ===&quot;);</b>
<b class="fc">&nbsp;        log.info(&quot;请求参数: keyword={}, page={}, size={}, sortBy={}, sortDirection={}&quot;, </b>
<b class="fc">&nbsp;                request.getKeyword(), request.getPage(), request.getSize(), </b>
<b class="fc">&nbsp;                request.getSortBy(), request.getSortDirection());</b>
&nbsp;        
&nbsp;        // 检查当前用户权限
<b class="fc">&nbsp;        Authentication auth = SecurityContextHolder.getContext().getAuthentication();</b>
<b class="fc">&nbsp;        log.info(&quot;当前认证用户: name={}, authorities={}&quot;, auth.getName(), auth.getAuthorities());</b>
&nbsp;        
<b class="fc">&nbsp;        Sort sort = Sort.by(</b>
<b class="fc">&nbsp;            &quot;desc&quot;.equalsIgnoreCase(request.getSortDirection()) ? </b>
<b class="fc">&nbsp;            Sort.Direction.DESC : Sort.Direction.ASC,</b>
<b class="fc">&nbsp;            request.getSortBy()</b>
&nbsp;        );
&nbsp;        
<b class="fc">&nbsp;        Pageable pageable = PageRequest.of(request.getPage(), request.getSize(), sort);</b>
&nbsp;        Page&lt;User&gt; users;
&nbsp;        
<b class="pc">&nbsp;        if (request.getKeyword() != null &amp;&amp; !request.getKeyword().trim().isEmpty()) {</b>
<b class="fc">&nbsp;            log.info(&quot;根据关键字搜索用户: {}&quot;, request.getKeyword());</b>
<b class="fc">&nbsp;            users = userRepository.searchUsers(request.getKeyword(), pageable);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            log.info(&quot;查询所有用户&quot;);</b>
<b class="fc">&nbsp;            users = userRepository.findAll(pageable);</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        log.info(&quot;查询结果: 总数={}, 当前页数量={}&quot;, users.getTotalElements(), users.getNumberOfElements());</b>
&nbsp;        
<b class="pc">&nbsp;        if (users.hasContent()) {</b>
<b class="fc">&nbsp;            users.getContent().forEach(user -&gt; {</b>
<b class="fc">&nbsp;                log.info(&quot;用户: id={}, email={}, username={}, role={}, status={}&quot;, </b>
<b class="fc">&nbsp;                        user.getId(), user.getEmail(), user.getUsername(), </b>
<b class="fc">&nbsp;                        user.getRole(), user.getStatus());</b>
&nbsp;            });
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        Page&lt;UserDTO.UserResponse&gt; result = users.map(UserDTO.UserResponse::fromEntity);</b>
<b class="fc">&nbsp;        log.info(&quot;=== UserService.searchUsers 结束 ===&quot;);</b>
<b class="fc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 更新用户状态（管理员功能）
&nbsp;     */
&nbsp;    public void updateUserStatus(Long userId, UserDTO.UserStatusUpdateRequest request) {
<b class="fc">&nbsp;        log.info(&quot;=== UserService.updateUserStatus 开始 ===&quot;);</b>
<b class="fc">&nbsp;        log.info(&quot;请求参数: userId={}, status={}&quot;, userId, request.getStatus());</b>
&nbsp;        
<b class="fc">&nbsp;        User user = userRepository.findById(userId)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new BusinessException(&quot;用户不存在&quot;));</b>
&nbsp;        
<b class="fc">&nbsp;        log.info(&quot;找到用户: id={}, email={}, 当前状态={}&quot;, user.getId(), user.getEmail(), user.getStatus());</b>
&nbsp;        
&nbsp;        // 枚举值应该用小写，所以用toLowerCase()而不是toUpperCase()
&nbsp;        User.UserStatus newStatus;
&nbsp;        try {
<b class="fc">&nbsp;            newStatus = User.UserStatus.valueOf(request.getStatus().toLowerCase());</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="fc">&nbsp;            log.error(&quot;无效的状态值: {}&quot;, request.getStatus());</b>
<b class="fc">&nbsp;            throw new BusinessException(&quot;无效的状态值: &quot; + request.getStatus());</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        log.info(&quot;状态转换: {} -&gt; {}&quot;, user.getStatus(), newStatus);</b>
<b class="fc">&nbsp;        user.setStatus(newStatus);</b>
&nbsp;        
<b class="fc">&nbsp;        user = userRepository.save(user);</b>
<b class="fc">&nbsp;        log.info(&quot;用户状态更新成功: 用户ID={}, 新状态={}, 原因={}&quot;, userId, newStatus, request.getReason());</b>
<b class="fc">&nbsp;        log.info(&quot;=== UserService.updateUserStatus 结束 ===&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取用户统计信息
&nbsp;     */
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public UserDTO.UserStatistics getUserStatistics() {
<b class="fc">&nbsp;        UserDTO.UserStatistics stats = new UserDTO.UserStatistics();</b>
&nbsp;        
<b class="fc">&nbsp;        stats.setTotalUsers(userRepository.count());</b>
<b class="fc">&nbsp;        stats.setActiveUsers(userRepository.countByStatus(User.UserStatus.active));</b>
<b class="fc">&nbsp;        stats.setAdminUsers(userRepository.countByRole(User.UserRole.admin));</b>
<b class="fc">&nbsp;        stats.setCustomerServiceUsers(userRepository.countByRole(User.UserRole.support));</b>
&nbsp;        
<b class="fc">&nbsp;        LocalDateTime monthStart = LocalDateTime.now().withDayOfMonth(1).withHour(0).withMinute(0).withSecond(0);</b>
<b class="fc">&nbsp;        stats.setNewUsersThisMonth(userRepository.countByCreatedAtAfter(monthStart));</b>
<b class="fc">&nbsp;        stats.setLockedUsers(userRepository.countByStatus(User.UserStatus.banned));</b>
&nbsp;        
<b class="fc">&nbsp;        return stats;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取当前登录用户的邮箱
&nbsp;     */
&nbsp;    private String getCurrentUserEmail() {
<b class="fc">&nbsp;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</b>
<b class="fc">&nbsp;        if (authentication == null || !authentication.isAuthenticated()) {</b>
<b class="fc">&nbsp;            throw new BusinessException(&quot;用户未登录&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return authentication.getName();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 根据邮箱查找用户
&nbsp;     */
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public Optional&lt;User&gt; findByEmail(String email) {
<b class="fc">&nbsp;        return userRepository.findByEmail(email);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 修改用户角色
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public UserDTO.UserResponse updateUserRole(Long userId, UserDTO.UserRoleUpdateRequest request) {
<b class="fc">&nbsp;        log.info(&quot;开始修改用户 {} 的角色为: {}&quot;, userId, request.getRole());</b>
&nbsp;        
&nbsp;        // 查找目标用户
<b class="fc">&nbsp;        User user = userRepository.findById(userId)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new BusinessException(&quot;用户不存在&quot;));</b>
&nbsp;        
&nbsp;        // 验证角色
&nbsp;        User.UserRole newRole;
&nbsp;        try {
<b class="fc">&nbsp;            newRole = User.UserRole.valueOf(request.getRole());</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="fc">&nbsp;            throw new BusinessException(&quot;无效的角色类型: &quot; + request.getRole());</b>
&nbsp;        }
&nbsp;        
&nbsp;        // 记录角色变更
<b class="fc">&nbsp;        User.UserRole oldRole = user.getRole();</b>
<b class="fc">&nbsp;        log.info(&quot;用户 {} ({}) 角色变更: {} -&gt; {}, 原因: {}&quot;, </b>
<b class="fc">&nbsp;                user.getUsername(), user.getEmail(), oldRole, newRole, request.getReason());</b>
&nbsp;        
&nbsp;        // 更新角色
<b class="fc">&nbsp;        user.setRole(newRole);</b>
&nbsp;        
&nbsp;        // 根据新角色设置相应的权限
<b class="pc">&nbsp;        switch (newRole) {</b>
&nbsp;            case admin:
<b class="fc">&nbsp;                user.setPermissions(&quot;ALL&quot;);</b>
&nbsp;                break;
&nbsp;            case support:
<b class="nc">&nbsp;                user.setPermissions(&quot;SUPPORT&quot;);</b>
&nbsp;                break;
&nbsp;            case user:
<b class="nc">&nbsp;                user.setPermissions(&quot;CHAT&quot;);</b>
&nbsp;                break;
&nbsp;            case pro:
&nbsp;                user.setPermissions(&quot;ALL&quot;);
&nbsp;                break;
<b class="fc">&nbsp;        }</b>
&nbsp;        
<b class="fc">&nbsp;        // 保存用户</b>
&nbsp;        user = userRepository.save(user);
<b class="fc">&nbsp;        </b>
&nbsp;        log.info(&quot;用户角色修改成功: {} -&gt; {}&quot;, oldRole, newRole);
&nbsp;        
&nbsp;        return UserDTO.UserResponse.fromEntity(user);
&nbsp;    }
&nbsp;
&nbsp;} 
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-18 23:35</div>
</div>
</body>
</html>
